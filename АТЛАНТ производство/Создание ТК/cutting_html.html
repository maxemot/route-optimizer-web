<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      flex-wrap: wrap;
    }
    .left-column {
      width: 48%;
      margin-right: 2%;
    }
    .right-column {
      width: 48%;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      margin-bottom: 30px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .status-stock {
      color: green;
      font-weight: bold;
    }
    .status-cutting {
      color: blue;
      font-weight: bold;
    }
    .status-not-found {
      color: red;
      font-weight: bold;
    }
    .status-buy {
      color: orange;
      font-weight: bold;
    }
    .status-extra {
      color: gray;
    }
    .efficiency {
      color: gray;
      font-weight: normal;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    h1 {
      color: #333;
      margin-top: 30px;
      width: 100%;
    }
    h2 {
      color: #555;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .eye-button {
      cursor: pointer;
      margin-left: 5px;
      vertical-align: middle;
    }
    .hidden-rows {
      display: none;
    }
    .summary-row {
      color: gray;
      background-color: #f9f9f9;
    }
    .col-1 {
      width: 40%;
    }
    .col-2 {
      width: 20%;
    }
    .col-3 {
      width: 40%;
    }
    .summary-box {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      width: 100%;
    }
    .summary-title {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    .summary-item {
      margin-bottom: 5px;
    }
    .warning {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
    .material-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .material-table th, .material-table td {
      border: 1px solid #ddd;
      padding: 6px 10px;
      text-align: left;
    }
    .material-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .material-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .cuttings-summary-table {
      width: 100%;
      margin-bottom: 20px;
    }
    .cuttings-summary-table th:nth-child(1), 
    .cuttings-summary-table td:nth-child(1) {
      width: 30%;
    }
    .cuttings-summary-table th:nth-child(2), 
    .cuttings-summary-table td:nth-child(2) {
      width: 20%;
    }
    .cuttings-summary-table th:nth-child(3), 
    .cuttings-summary-table td:nth-child(3) {
      width: 10%;
      text-align: center;
    }
    .cuttings-summary-table th:nth-child(4), 
    .cuttings-summary-table td:nth-child(4) {
      width: 15%;
      text-align: center;
    }
    .cuttings-summary-table th:nth-child(5), 
    .cuttings-summary-table td:nth-child(5) {
      width: 25%;
      text-align: center;
    }
    .create-tk-button {
      background-color: #4CAF50;
      color: white;
      padding: 6.75px 13.5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: 0.99em;
    }
    
    .create-tk-button:hover {
      background-color: #45a049;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .create-tk-button:active {
      background-color: #3e8e41;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transform: translateY(2px);
    }
    
    .create-tk-button:disabled {
      background-color: #cccccc;
      color: #666666;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .create-tk-button.tk-created {
      background-color: #cccccc;
      color: #666666;
      cursor: default;
    }
    .warning-box {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      width: 100%;
    }
    
    .warning-content {
      display: flex;
      align-items: center;
      color: #d32f2f;
      font-weight: bold;
    }
    
    .warning-icon {
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    .warning-text {
      flex: 1;
    }
    
    #missing-parts-list {
      font-weight: normal;
    }
  </style>
  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¢–ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
      checkTechCardsStatus();
      checkCuttingsStatus();
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ—Ö. –∫–∞—Ä—Ç
    function checkTechCardsStatus() {
      var allCreated = true;
      var table = document.querySelector('.right-column table');
      
      if (table) {
        var rows = table.getElementsByTagName('tr');
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–Ω–¥–µ–∫—Å 0)
        for (var i = 1; i < rows.length; i++) {
          var cells = rows[i].getElementsByTagName('td');
          if (cells.length >= 4) {
            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã —Å—Ç–∞—Ç—É—Å "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            if (cells[3].textContent.trim() === "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞") {
              allCreated = false;
              break;
            }
          }
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      var button = document.getElementById('createTKButton');
      if (button) {
        if (allCreated) {
          // –ï—Å–ª–∏ –≤—Å–µ –¢–ö —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã
          button.disabled = true;
          button.textContent = '–¶–µ—Ö —Å–æ–∑–¥–∞–Ω';
          button.classList.add('tk-created');
        } else {
          // –ï—Å–ª–∏ –µ—Å—Ç—å –¢–ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ü–µ—Ö';
          button.classList.remove('tk-created');
        }
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–∫—Ä–æ–µ–≤
    function checkCuttingsStatus() {
      var allCreated = true;
      var cuttingsTable = document.querySelector('.cuttings-summary-table');
      
      if (cuttingsTable) {
        var rows = cuttingsTable.getElementsByTagName('tr');
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–Ω–¥–µ–∫—Å 0)
        for (var i = 1; i < rows.length; i++) {
          var cells = rows[i].getElementsByTagName('td');
          if (cells.length >= 5) {
            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞—Å–∫—Ä–æ—è —Å—Ç–∞—Ç—É—Å "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            if (cells[4].textContent.trim() === "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞") {
              allCreated = false;
              break;
            }
          }
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      var button = document.getElementById('createCuttingsButton');
      if (button) {
        if (allCreated) {
          // –ï—Å–ª–∏ –≤—Å–µ —Ä–∞—Å–∫—Ä–æ–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã
          button.disabled = true;
          button.textContent = '–†–∞—Å–∫—Ä–æ–∏ —Å–æ–∑–¥–∞–Ω—ã';
          button.classList.add('tk-created');
        } else {
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–∫—Ä–æ–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–∫—Ä–æ–∏';
          button.classList.remove('tk-created');
        }
      }
    }
    
    function toggleExtraParts(tableId, buttonId) {
      var table = document.getElementById(tableId);
      var button = document.getElementById(buttonId);
      var hiddenRows = table.getElementsByClassName('hidden-row');
      var summaryRow = table.getElementsByClassName('summary-row')[0];
      
      // –ï—Å–ª–∏ –Ω–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä–æ–∫, –≤—ã—Ö–æ–¥–∏–º
      if (hiddenRows.length === 0) return;
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä–æ–∫
      var isHidden = hiddenRows[0].classList.contains('hidden-rows');
      
      for (var i = 0; i < hiddenRows.length; i++) {
        if (isHidden) {
          hiddenRows[i].classList.remove('hidden-rows');
        } else {
          hiddenRows[i].classList.add('hidden-rows');
        }
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å —Å—É–º–º–æ–π
      if (isHidden) {
        summaryRow.classList.add('hidden-rows');
        button.innerHTML = 'üêµ'; // –û—Ç–∫—Ä—ã—Ç—ã–π –≥–ª–∞–∑ (–æ–±–µ–∑—å—è–Ω–∫–∞)
      } else {
        summaryRow.classList.remove('hidden-rows');
        button.innerHTML = 'üôà'; // –ó–∞–∫—Ä—ã—Ç—ã–π –≥–ª–∞–∑ (–æ–±–µ–∑—å—è–Ω–∫–∞ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è –≥–ª–∞–∑–∞)
      }
    }
    
    function createTK() {
      var button = document.getElementById('createTKButton');
      // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º –µ–µ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥
      button.disabled = true;
      button.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ—Ö–∞...';
      
      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
      google.script.run
        .withSuccessHandler(function(result) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          onTKCreated(result);
        })
        .withFailureHandler(function(error) {
          // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ü–µ—Ö';
          
          // –£–¥–∞–ª—è–µ–º alert —Å –æ—à–∏–±–∫–æ–π
        })
        .createTechCards();
    }
    
    function createCuttings() {
      var button = document.getElementById('createCuttingsButton');
      // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º –µ–µ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥
      button.disabled = true;
      button.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–∫—Ä–æ–µ–≤...';
      
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å–∫—Ä–æ—è—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
      var cuttingsData = [];
      var cuttingsTable = document.querySelector('.cuttings-summary-table');
      
      if (cuttingsTable) {
        var rows = cuttingsTable.getElementsByTagName('tr');
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–Ω–¥–µ–∫—Å 0)
        for (var i = 1; i < rows.length; i++) {
          var cells = rows[i].getElementsByTagName('td');
          if (cells.length >= 5) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Ä–∞—Å–∫—Ä–æ–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã
            if (cells[4].textContent.trim() === "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞") {
              cuttingsData.push({
                cutting: cells[1].textContent.trim(), // –ê—Ä—Ç–∏–∫—É–ª —Ä–∞—Å–∫—Ä–æ—è
                quantity: parseInt(cells[2].textContent.trim()) // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
              });
            }
          }
        }
      }
      
      // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞—Å–∫—Ä–æ–µ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, –≤—ã—Ö–æ–¥–∏–º
      if (cuttingsData.length === 0) {
        button.disabled = false;
        button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–∫—Ä–æ–∏';
        // –£–¥–∞–ª—è–µ–º alert
        return;
      }
      
      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
      google.script.run
        .withSuccessHandler(function(result) {
          // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–∫—Ä–æ–∏';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          onCuttingsCreated(result);
        })
        .withFailureHandler(function(error) {
          // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–∫—Ä–æ–∏';
          
          // –£–¥–∞–ª—è–µ–º alert —Å –æ—à–∏–±–∫–æ–π
        })
        .createCuttingCards(cuttingsData);
    }
    
    function onTKCreated(result) {
      if (result && result.success) {
        if (result.allCreated) {
          // –ï—Å–ª–∏ –≤—Å–µ –¢–ö —Å–æ–∑–¥–∞–Ω—ã (–≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ —Ä–∞–Ω–µ–µ)
          var button = document.getElementById('createTKButton');
          button.disabled = true;
          button.textContent = '–¶–µ—Ö —Å–æ–∑–¥–∞–Ω';
          button.classList.add('tk-created');
      } else {
          // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–µ –≤—Å–µ –¢–ö
          var button = document.getElementById('createTKButton');
          button.disabled = false;
          button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ü–µ—Ö';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
        if (result.createdTKs) {
          var table = document.querySelector('.right-column table');
          if (table) {
            var rows = table.getElementsByTagName('tr');
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–Ω–¥–µ–∫—Å 0)
            for (var i = 1; i < rows.length; i++) {
              var cells = rows[i].getElementsByTagName('td');
              if (cells.length >= 4) {
                var code = cells[0].textContent.trim();
                if (result.createdTKs[code]) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
                  cells[3].textContent = result.createdTKs[code];
                }
              }
            }
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –¢–ö —Å–æ–∑–¥–∞–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        checkTechCardsStatus();
      } else {
        var button = document.getElementById('createTKButton');
        button.disabled = false;
        button.textContent = '–°–æ–∑–¥–∞—Ç—å —Ü–µ—Ö';
      }
    }
    
    function onCuttingsCreated(result) {
      if (result && result.success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
        if (result.createdCuttingTKs) {
          var table = document.querySelector('.cuttings-summary-table');
          if (table) {
            var rows = table.getElementsByTagName('tr');
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–Ω–¥–µ–∫—Å 0)
            for (var i = 1; i < rows.length; i++) {
              var cells = rows[i].getElementsByTagName('td');
              if (cells.length >= 5) {
                var cuttingNumber = cells[1].textContent.trim();
                if (result.createdCuttingTKs[cuttingNumber]) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
                  cells[4].textContent = result.createdCuttingTKs[cuttingNumber];
                }
              }
            }
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Ä–∞—Å–∫—Ä–æ–∏ —Å–æ–∑–¥–∞–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        checkCuttingsStatus();
      }
    }

    window.addEventListener('DOMContentLoaded', function() {
      // –ü–æ–ª—É—á–∞–µ–º –∞—Ä—Ç–∏–∫—É–ª –∏–∑–¥–µ–ª–∏—è –∏–∑ data.targetProduct
      var productCode = "<?= data.targetProduct ?>";
      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è base64-—Å—Ç—Ä–æ–∫–∏ —Ñ–æ—Ç–æ
      google.script.run.withSuccessHandler(function(photoBase64) {
        var img = document.getElementById('product-photo');
        if (photoBase64 && photoBase64.startsWith('data:image/')) {
          img.src = photoBase64;
          // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏
          var dbg = document.getElementById('photo-debug');
          dbg.style.display = 'block';
          dbg.textContent = '–î–ª–∏–Ω–∞: ' + photoBase64.length;
        } else {
          // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É
          img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNmNmY2ZjYiIHJ4PSIxNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjY2NjIj7Qk9RPPPCfkIwg0J7QsdCw0L3QvtC80LAg0L/QvtC70YzQvdC+PC90ZXh0Pjwvc3ZnPg==';
      }
      }).getProductPhotoBase64(productCode);
    });
  </script>
</head>
<body>
  <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ –∑–∞–∫–∞–∑—É -->
  <div class="summary-box">
    <div style="display: flex; align-items: center;">
      <div style="width: 120px; height: 120px; min-width: 120px; min-height: 120px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 18px;">
        <img id="product-photo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNmNmY2ZjYiIHJ4PSIxNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjY2NjIj7Qk9RPPPCfkIwg0J7QsdCw0L3QvtC80LAg0L/QvtC70YzQvdC+PC90ZXh0Pjwvc3ZnPg==" alt="—Ñ–æ—Ç–æ" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
        <div id="photo-debug" style="font-size:10px;word-break:break-all;max-width:110px;overflow:auto;line-height:1.1;margin-top:2px;display:none;"></div>
      </div>
      <div>
    <div class="summary-title">
          –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–∫–∞–∑—É
    </div>
        <div class="summary-item">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: <?= data.orderNumber ?></div>
        <div class="summary-item">–ê—Ä—Ç–∏–∫—É–ª –∏–∑–¥–µ–ª–∏—è: <?= data.targetProduct ?></div>
        <div class="summary-item">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <?= typeof data.quantity === 'number' ? Math.round(data.quantity) : (data.quantity || 1) ?></div>
      </div>
    </div>
  </div>
  
  <!-- –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π -->
  <div id="missing-parts-warning" class="warning-box" style="display: none;">
    <div class="warning-content">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <span class="warning-text">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–µ—Ç–∞–ª–∏: <span id="missing-parts-list"></span></span>
    </div>
  </div>
  
  <?!= data.warningHtml ?>
  
  <div class="left-column">
    <!-- 1. –ë–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å–∫—Ä–æ—è -->
    <? if (!isEmptyObject(data.selectedCuttings)) { ?>
      <h2>
        –†–∞—Å–∫—Ä–æ–∏
        <button id="createCuttingsButton" class="create-tk-button" onclick="createCuttings()">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–∫—Ä–æ–∏</button>
      </h2>
      
      <!-- –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –∫—Ä–∞—Ç–∫–∏–º —Å–ø–∏—Å–∫–æ–º —Ä–∞—Å–∫—Ä–æ–µ–≤ -->
      <table class="cuttings-summary-table">
        <tr>
          <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
          <th>–†–∞—Å–∫—Ä–æ–π</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
        <? 
        // 1. –§–æ—Ä–º–∏—Ä—É–µ–º cuttingsList —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –¥–æ –≤—ã–≤–æ–¥–∞ –≤–µ—Ä—Ö–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã
        var cuttingsList = [];
        var cuttingEfficiencies = {};
        for (var cuttingNumber in data.selectedCuttings) {
          var usefulCountForCutting = 0;
          var totalCountForCutting = 0;
          for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
            var part = data.cuttings[cuttingNumber][i];
            var partCode = part.partCode;
            var quantity = part.quantity * Math.round(data.selectedCuttings[cuttingNumber]);
            totalCountForCutting += quantity;
              var usedFromThisCutting = 0;
            if (data.partsToCut[partCode]) {
              if (data.partToCutting[partCode]) {
                for (var j = 0; j < data.partToCutting[partCode].length; j++) {
                  if (data.partToCutting[partCode][j][0] === cuttingNumber) {
                    usedFromThisCutting = data.partToCutting[partCode][j][1] * Math.round(data.selectedCuttings[cuttingNumber]);
                    break;
                  }
                }
              }
              var maxNeeded = data.partsToCut[partCode] || 0;
              var used = Math.min(usedFromThisCutting, maxNeeded);
              usefulCountForCutting += used;
            }
          }
          var efficiencyForCutting = 0;
          if (totalCountForCutting > 0) {
            efficiencyForCutting = usefulCountForCutting / totalCountForCutting * 100;
          }
          cuttingEfficiencies[cuttingNumber] = efficiencyForCutting >= 1 ? Math.round(efficiencyForCutting) + "%" : efficiencyForCutting.toFixed(1).replace('.', ',') + "%";
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ä–∞—Å–∫—Ä–æ—è
          var materialName = "–†–∞—Å–∫—Ä–æ–π";
          if (data.cuttings[cuttingNumber] && data.cuttings[cuttingNumber].length > 0) {
            var partCode = data.cuttings[cuttingNumber][0].partCode;
            var match = partCode.match(/[–ê-–Ø]+/);
            if (match && data.materialNames && data.materialNames[match[0]]) {
              materialName = data.materialNames[match[0]];
            } else if (match) {
              materialName = "–†–∞—Å–∫—Ä–æ–π " + match[0];
            }
          }
          cuttingsList.push({
            material: materialName,
            number: cuttingNumber,
            quantity: Math.round(data.selectedCuttings[cuttingNumber]),
            efficiency: cuttingEfficiencies[cuttingNumber],
            status: (data.cuttingTKs && data.cuttingTKs[cuttingNumber]) ? data.cuttingTKs[cuttingNumber] : "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
          });
        }
        
        // 2. –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫—Ä–æ–µ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã
        var materialCounts = {};
        for (var i = 0; i < cuttingsList.length; i++) {
          var material = cuttingsList[i].material;
          var quantity = cuttingsList[i].quantity;
          materialCounts[material] = (materialCounts[material] || 0) + quantity;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–∞—Å–∫—Ä–æ–∏ –ø–æ –Ω–æ–º–µ—Ä—É (–∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
        cuttingsList.sort(function(a, b) {
          return a.number.localeCompare(b.number);
        });
        
        // –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        for (var i = 0; i < cuttingsList.length; i++) {
          var cutting = cuttingsList[i];
        ?>
          <tr>
            <td><?= cutting.material ?></td>
            <td><?= cutting.number ?></td>
            <td><?= cutting.quantity ?></td>
            <td><?= cutting.efficiency ?></td>
            <td><?= cutting.status ?></td>
          </tr>
        <? } ?>
      </table>
      
      <? 
      var tableId = 0;
      for (var cuttingNumber in data.selectedCuttings) { 
        tableId++;
        var currentTableId = "table_" + tableId;
        var currentButtonId = "button_" + tableId;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞—Å–∫—Ä–æ—è
        var usefulArea = 0;
        var totalArea = 0;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –≤ —Ä–∞—Å–∫—Ä–æ–µ
        var partCodes = [];
        for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
          partCodes.push(data.cuttings[cuttingNumber][i].partCode);
        }
        var uniquePartCodes = [];
        var hasDuplicates = false;
        
        for (var i = 0; i < partCodes.length; i++) {
          if (uniquePartCodes.indexOf(partCodes[i]) === -1) {
            uniquePartCodes.push(partCodes[i]);
          } else {
            hasDuplicates = true;
            break;
          }
        }
        
        for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
          var part = data.cuttings[cuttingNumber][i];
          var partCode = part.partCode;
          var quantity = part.quantity;
          var area = part.area;
          
          // –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –≤ —Ä–∞—Å–∫—Ä–æ–µ
          totalArea += area * quantity;
          
          // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –Ω—É–∂–Ω–∞ –¥–ª—è –∏–∑–¥–µ–ª–∏—è, —Å—á–∏—Ç–∞–µ–º –ø–æ–ª–µ–∑–Ω—É—é –ø–ª–æ—â–∞–¥—å
          if (data.partsToCut[partCode]) {
            var usedFromThisCutting = 0;
            if (data.partToCutting[partCode]) {
              for (var j = 0; j < data.partToCutting[partCode].length; j++) {
                if (data.partToCutting[partCode][j][0] === cuttingNumber) {
                  usedFromThisCutting = data.partToCutting[partCode][j][1];
                  break;
                }
              }
            }
            
            var maxNeeded = data.partsToCut[partCode] || 0;
            var used = Math.min(usedFromThisCutting, maxNeeded);
            usefulArea += area * used;
          }
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        var efficiency = 0;
        if (totalArea > 0) {
          efficiency = usefulArea / totalArea * 100;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ 0%, —Ç–æ –≤—ã–≤–æ–¥–∏–º —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 1 –∑–Ω–∞–∫–∞
        var efficiencyStr = efficiency >= 1 ? Math.round(efficiency) + "%" : efficiency.toFixed(1).replace('.', ',') + "%";
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∞—Ä—Ç–∏–∫—É–ª–∞—Ö
        var errorStr = hasDuplicates ? ' <span style="color: red; font-weight: bold;">‚ö†Ô∏è–û—à–∏–±–∫–∞</span>' : '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Ä–∞—Å–∫—Ä–æ–µ
        var materials = [];
        var hasMixedMaterials = false;
        
        for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
          var partCode = data.cuttings[cuttingNumber][i].partCode;
          
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –±—É–∫–≤–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –∞—Ä—Ç–∏–∫—É–ª–∞ (–º–∞—Ç–µ—Ä–∏–∞–ª)
          var material = "";
          var match = partCode.match(/[–ê-–Ø]+/);
          if (match) {
            material = match[0];
            if (materials.indexOf(material) === -1) {
              materials.push(material);
            }
          }
        }
        
        // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, —É–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –æ—à–∏–±–∫—É
        hasMixedMaterials = materials.length > 1;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ä–∞—Å–∫—Ä–æ—è
        var materialName = "–†–∞—Å–∫—Ä–æ–π"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (!hasMixedMaterials && materials.length === 1) {
          // –ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –æ–¥–∏–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –µ–≥–æ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
          var shortName = materials[0];
          if (data.materialNames && data.materialNames[shortName]) {
            materialName = data.materialNames[shortName];
          }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        var materialsErrorStr = hasMixedMaterials ? 
          ' <span style="color: red; font-weight: bold;">–æ—à–∏–±–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</span>' : '';
        
        // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–ª–æ–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–∞—Å–∫—Ä–æ—é
        var usefulCountForCutting = 0;
        var totalCountForCutting = 0;
        for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
          var part = data.cuttings[cuttingNumber][i];
          var partCode = part.partCode;
          var quantity = part.quantity * Math.round(data.selectedCuttings[cuttingNumber]);
          totalCountForCutting += quantity;
          var usedFromThisCutting = 0;
          if (data.partsToCut[partCode]) {
            if (data.partToCutting[partCode]) {
              for (var j = 0; j < data.partToCutting[partCode].length; j++) {
                if (data.partToCutting[partCode][j][0] === cuttingNumber) {
                  usedFromThisCutting = data.partToCutting[partCode][j][1] * Math.round(data.selectedCuttings[cuttingNumber]);
                  break;
                }
              }
            }
            var maxNeeded = data.partsToCut[partCode] || 0;
            var used = Math.min(usedFromThisCutting, maxNeeded);
            usefulCountForCutting += used;
          }
        }
        var efficiencyForCutting = 0;
        if (totalCountForCutting > 0) {
          efficiencyForCutting = usefulCountForCutting / totalCountForCutting * 100;
        }
        var efficiencyStrForCutting = efficiencyForCutting >= 1 ? Math.round(efficiencyForCutting) + "%" : efficiencyForCutting.toFixed(1).replace('.', ',') + "%";
      ?>
      
      <h3><?= materialName ?> <?= cuttingNumber ?> (<?= Math.round(data.selectedCuttings[cuttingNumber]) ?> —à—Ç) 
        <span class="efficiency">—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å <?= efficiencyStrForCutting ?></span>
        <?!= errorStr ?><?!= materialsErrorStr ?>
      </h3>
      <table id="<?= currentTableId ?>">
        <tr>
          <?
          // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ —ç—Ç–æ–º —Ä–∞—Å–∫—Ä–æ–µ
          var neededPartsArray = [];
          var extraPartsInCutting = [];
          
          for (var i = 0; i < data.cuttings[cuttingNumber].length; i++) {
            var part = data.cuttings[cuttingNumber][i];
            var partCode = part.partCode;
            var quantityInCutting = part.quantity;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ –¥–µ—Ç–∞–ª—å –∏ —Å–∫–æ–ª—å–∫–æ
            var totalNeeded = data.components[partCode] || 0;
            var stockQty = data.stock[partCode] || 0;
            
            // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –Ω—É–∂–Ω–∞ –¥–ª—è –∏–∑–¥–µ–ª–∏—è
            if (data.components[partCode]) {
              // –°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –≤—ã—Ä–µ–∑–∞—Ç—å (—Å —É—á–µ—Ç–æ–º —Å–∫–ª–∞–¥–∞)
              var toCut = Math.max(0, totalNeeded - stockQty);
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              var cuttingQuantity = Math.round(data.selectedCuttings[cuttingNumber]);
              var usedFromThisCutting = 0;
              if (data.partToCutting[partCode]) {
                for (var j = 0; j < data.partToCutting[partCode].length; j++) {
                  if (data.partToCutting[partCode][j][0] === cuttingNumber) {
                    usedFromThisCutting = data.partToCutting[partCode][j][1];
                    break;
                  }
                }
              }
              
              // –£–º–Ω–æ–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω—É–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫—Ä–æ–µ–≤, 
              // –Ω–æ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—è –æ–±—â—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –¥–ª—è —ç—Ç–æ–π –¥–µ—Ç–∞–ª–∏
              var totalNeededForAll = data.partsToCut[partCode]; // –û–±—â–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –¥–µ—Ç–∞–ª–∏
              
              // –£–º–Ω–æ–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –æ–¥–Ω–æ–º —Ä–∞—Å–∫—Ä–æ–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–∫—Ä–æ–µ–≤
              var availableInThisCutting = Math.round(usedFromThisCutting) * cuttingQuantity;
              // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—à–Ω–∏—Ö - —ç—Ç–æ –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–µ—Ç —Ä–∞—Å–∫—Ä–æ–π, –º–∏–Ω—É—Å –Ω—É–∂–Ω—ã–µ
              var totalPartsInCuttings = Math.round(quantityInCutting) * cuttingQuantity;
              
              var neededPartsCount = Math.min(availableInThisCutting, totalNeededForAll);
              var extraParts = totalPartsInCuttings - neededPartsCount;
              
              var status = "–Ω—É–∂–Ω–æ " + neededPartsCount + ", –ª–∏—à–Ω–∏–µ " + extraParts;
              var statusClass = "";
              
              // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –Ω—É–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π
              neededPartsArray.push({
                'partCode': partCode,
                'stockQty': stockQty,
                'status': status,
                'needed': neededPartsCount,
                'extra': extraParts,
                'statusClass': statusClass
              });
            } else {
              // –î–µ—Ç–∞–ª—å –Ω–µ –Ω—É–∂–Ω–∞ –¥–ª—è –∏–∑–¥–µ–ª–∏—è
              var cuttingQuantity = Math.round(data.selectedCuttings[cuttingNumber]);
              var extraParts = Math.round(quantityInCutting) * cuttingQuantity;
              var status = "–Ω—É–∂–Ω–æ 0, –ª–∏—à–Ω–∏–µ " + extraParts;
              var statusClass = "status-extra";
              
              // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π
              extraPartsInCutting.push({
                'partCode': partCode,
                'stockQty': stockQty,
                'status': status,
                'needed': 0,
                'extra': quantityInCutting * cuttingQuantity,
                'statusClass': statusClass
              });
            }
          }
          
          // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π
          var totalExtraParts = extraPartsInCutting.length;
          ?>
          
          <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å –≥–ª–∞–∑–æ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ -->
          <? if (totalExtraParts > 0) { ?>
            <th class="col-1">–ê—Ä—Ç–∏–∫—É–ª <span id="<?= currentButtonId ?>" class="eye-button" onclick="toggleExtraParts('<?= currentTableId ?>', '<?= currentButtonId ?>')">üôà</span></th>
          <? } else { ?>
            <th class="col-1">–ê—Ä—Ç–∏–∫—É–ª</th>
          <? } ?>
          <th class="col-2">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
          <th class="col-3">–°—Ç–∞—Ç—É—Å</th>
        </tr>
        
        <!-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–≤–æ–¥–∏–º –Ω—É–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ -->
        <? for (var i = 0; i < neededPartsArray.length; i++) { 
          var part = neededPartsArray[i];
        ?>
          <tr class="<?= part.statusClass ?>">
            <td><?= part.partCode ?></td>
            <td><?= Math.round(part.stockQty) ?></td>
            <td><?= part.status ?></td>
          </tr>
        <? } ?>
        
        <? 
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π
        var totalStockQty = 0;
        var totalNeeded = 0;
        var totalExtra = 0;
        
        for (var i = 0; i < extraPartsInCutting.length; i++) {
          totalStockQty += extraPartsInCutting[i].stockQty;
          totalNeeded += extraPartsInCutting[i].needed;
          totalExtra += extraPartsInCutting[i].extra;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å —Å—É–º–º–æ–π –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏
        if (totalExtraParts > 0) {
        ?>
          <tr class="summary-row">
            <td>–õ–∏—à–Ω–∏—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤ <?= totalExtraParts ?></td>
            <td><?= Math.round(totalStockQty) ?></td>
            <td>–Ω—É–∂–Ω–æ <?= Math.round(totalNeeded) ?>, –ª–∏—à–Ω–∏–µ <?= Math.round(totalExtra) ?></td>
          </tr>
          
          <!-- –ó–∞—Ç–µ–º –≤—ã–≤–æ–¥–∏–º –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç—ã–µ) -->
          <? for (var i = 0; i < extraPartsInCutting.length; i++) { 
            var part = extraPartsInCutting[i];
          ?>
            <tr class="<?= part.statusClass ?> hidden-row hidden-rows">
              <td><?= part.partCode ?></td>
              <td><?= Math.round(part.stockQty) ?></td>
              <td><?= part.status ?></td>
            </tr>
          <? } ?>
        <? } ?>
      </table>
      <? } ?>
    <? } ?>
  </div>
  
  <div class="right-column">
    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ —Å—Ö–µ–º—ã -->
    <? if (data.uniqueValues && data.uniqueValues.length > 0) { ?>
      <h2>
        –¶–µ—Ö
        <button id="createTKButton" class="create-tk-button" onclick="createTK()">–°–æ–∑–¥–∞—Ç—å —Ü–µ—Ö–∞</button>
      </h2>
      <table>
        <tr>
          <th style="width:35%">–ê—Ä—Ç–∏–∫—É–ª</th>
          <th style="width:10%">–ö–æ–ª-–≤–æ</th>
          <th style="width:35%">–û–ø–µ—Ä–∞—Ü–∏–∏</th>
          <th style="width:20%">–°—Ç–∞—Ç—É—Å</th>
        </tr>
        <? for (var i = 0; i < data.uniqueValues.length; i++) { ?>
          <tr>
            <td><?= data.uniqueValues[i].code ?></td>
            <td><?= data.uniqueValues[i].quantity ?></td>
            <td><?= data.uniqueValues[i].operations ?></td>
            <td><?= data.uniqueValues[i].tkNumber || "–Ω–µ —Å–æ–∑–¥–∞–Ω–∞" ?></td>
          </tr>
        <? } ?>
      </table>
    <? } ?>
    
    <!-- 2. –ë–ª–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å -->
    <? 
    var partsToBuy = {};
    for (var part in data.components) {
      if (!isCuttingPart(part)) {  // –ù–µ —Ä–∞—Å–∫—Ä–æ–π–Ω–∞—è –¥–µ—Ç–∞–ª—å
        var stockQty = data.stock[part] || 0;
        var qty = data.components[part];
        if (stockQty < qty) {  // –ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å
          partsToBuy[part] = qty - stockQty;
        }
      }
    }
    
    function isCuttingPart(partCode) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–æ–¥ –±—É–∫–≤—É "–†" —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –¥—Ä—É–≥–∏–º–∏ –±—É–∫–≤–∞–º–∏ –ø–æ—Å–ª–µ –Ω–µ—ë
      if (partCode.indexOf('–†') === -1) {
        return false;
      }
      
      // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –±—É–∫–≤—ã "–†"
      var rPos = partCode.indexOf('–†');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ –±—É–∫–≤—ã "–†" —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫–∏
      var beforeR = partCode.substring(0, rPos);
      for (var i = 0; i < beforeR.length; i++) {
        var c = beforeR.charAt(i);
        if (!(c >= '0' && c <= '9') && c !== '.') {
          return false;
        }
      }
      
      return true;
    }
    
    function isEmptyObject(obj) {
      for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
          return false;
        }
      }
      return true;
    }
    
    if (!isEmptyObject(partsToBuy)) {
      tableId++;
      var currentTableId = "table_" + tableId;
      var currentButtonId = "button_" + tableId;
    ?>
      <h2>–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</h2>
      <table id="<?= currentTableId ?>">
        <tr>
          <th>–ê—Ä—Ç–∏–∫—É–ª</th>
          <th>–ù–∞ —Å–∫–ª–∞–¥–µ</th>
          <th>–ö—É–ø–∏—Ç—å</th>
        </tr>
        
        <? 
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –æ–±—ä–µ–∫—Ç–∞
        var sortedKeys = Object.keys(partsToBuy).sort();
        for (var i = 0; i < sortedKeys.length; i++) {
          var part = sortedKeys[i];
          var qtyToBuy = partsToBuy[part];
          var stockQty = data.stock[part] || 0;
        ?>
          <tr>
            <td><?= part ?></td>
            <td><?= Math.round(stockQty) ?></td>
            <td><?= Math.round(qtyToBuy) ?></td>
          </tr>
        <? } ?>
      </table>
    <? } ?>
    
    <!-- 3. –ë–ª–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ -->
    <? 
    var partsInStock = {};
    for (var part in data.components) {
      var qty = data.components[part];
      var stockQty = data.stock[part] || 0;
      if (stockQty > 0) {  // –ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ (—Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏—á–Ω–æ)
        partsInStock[part] = Math.min(qty, stockQty);  // –ë–µ—Ä–µ–º —Å–æ —Å–∫–ª–∞–¥–∞ —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ —á–µ–º –Ω—É–∂–Ω–æ
      }
    }
    
    if (!isEmptyObject(partsInStock)) {
      tableId++;
      var currentTableId = "table_" + tableId;
      var currentButtonId = "button_" + tableId;
    ?>
      <h2>–ï—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ</h2>
      <table id="<?= currentTableId ?>">
        <tr>
          <th>–ê—Ä—Ç–∏–∫—É–ª</th>
          <th>–ù–∞ —Å–∫–ª–∞–¥–µ</th>
          <th>–ë–µ—Ä–µ–º</th>
        </tr>
        
        <? 
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –æ–±—ä–µ–∫—Ç–∞
        var sortedKeys = Object.keys(partsInStock).sort();
        for (var i = 0; i < sortedKeys.length; i++) {
          var part = sortedKeys[i];
          var qtyUsed = partsInStock[part];
          var stockQty = data.stock[part] || 0;
        ?>
          <tr>
            <td><?= part ?></td>
            <td><?= Math.round(stockQty) ?></td>
            <td><?= Math.round(qtyUsed) ?></td>
          </tr>
        <? } ?>
      </table>
    <? } ?>
  </div>
</body>
</html> 