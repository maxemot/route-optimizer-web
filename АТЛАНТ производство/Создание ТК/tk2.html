<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background-color: #fff;
    }
    .summary-box {
      background-color: #fff;
      border: none;
      padding: 15px 10px;
      margin-bottom: 4px;
      width: 100%;
      max-width: none;
      box-sizing: border-box;
      box-shadow: none;
    }
    .summary-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1em;
      color: #333;
    }
    .summary-item {
      margin-bottom: 5px;
      font-size: 1em;
    }
    .operation-box {
        font-weight: bold;
        text-align: center;
        margin: 4px 0 10px 0;
        padding: 15px 10px;
        border-radius: 8px;
        width: 100%;
        max-width: none;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
        position: relative;
    }
    .operation-status {
      display: block;
      font-size: 1.6em;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: bold;
    }
    .operation-name {
      font-size: 2.2em;
      color: #333;
    }
    .action-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        background: #fff;
        border: 2px solid #9166AA;
        border-radius: 10px;
        padding: 20px 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        width: 100%;
        max-width: none;
        box-sizing: border-box;
        margin-top: 20px;
    }
    .action-info {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px 15px;
        width: 100%;
        font-size: 1.1em;
    }
    .action-label {
        color: #888;
        text-align: left;
    }
    .action-value {
        font-weight: bold; 
        color: #222;
    }
    .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
        width: 100%;
    }
    .main-actions, .secondary-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      width: 100%;
    }
    .action-button {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 160px;
        flex: none;
    }
    .start-button, .resume-button { background-color: #E6BFBF; }
    .start-button:hover:not(:disabled), .resume-button:hover:not(:disabled) { background-color: #D9AFAF; }
    
    .finish-button { background-color: #B2D8B4; }
    .finish-button:hover:not(:disabled) { background-color: #A1C9A3; }

    .pause-button { background-color: #e0e0e0; }
    .pause-button:hover:not(:disabled) { background-color: #bdbdbd; }

    .reset-button { background-color: #ef9a9a; }
    .reset-button:hover:not(:disabled) { background-color: #e57373; }

    .action-button:disabled {
        background-color: #cccccc;
        color: #666666;
        cursor: not-allowed;
    }
    .print-button {
        background: none;
        border: none;
        font-size: 2em;
        cursor: pointer;
        color: #888;
    }
    .print-button:disabled {
        color: #ccc;
        cursor: not-allowed;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .loading-icon {
      font-size: 5em;
      animation: spin-broom 1.5s linear infinite;
    }
    .loading-text {
      font-size: 1.5em;
      margin-top: 20px;
      color: #333;
    }
    .loading-text::after {
      overflow: hidden;
      display: inline-block;
      vertical-align: bottom;
      animation: ellipsis-dot 1.5s infinite steps(4, end);
      content: "...";
    }
    @keyframes spin-broom {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(-90deg); }
      100% { transform: rotate(0deg); }
    }
    @keyframes ellipsis-dot {
      0% { content: ""; }
      25% { content: "."; }
      50% { content: ".."; }
      75% { content: "..."; }
    }
    .warning-box {
      display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      background-color: #ffebee;
      border: 1px solid #d32f2f;
      color: #d32f2f;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      max-width: 550px;
      box-sizing: border-box;
    }
    .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #6c757d;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        margin-right: 8px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body data-script-data="<?!= encodeURIComponent(JSON.stringify(data)) ?>">
<div id="mainContent">
  <!-- 1. –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ –∑–∞–∫–∞–∑—É -->
  <div class="summary-box">
    <div style="display: flex; align-items: flex-start;">
      <div style="width: 180px; height: 180px; min-width: 180px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
        <img id="product-photo" src="" alt="—Ñ–æ—Ç–æ" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;" />
        <span id="photo-placeholder">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
      </div>
      <div>
        <div class="summary-item"><b>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</b> <?= data.orderNumber ?></div>
        <div class="summary-item"><b>–ê—Ä—Ç–∏–∫—É–ª –∏–∑–¥–µ–ª–∏—è:</b> <?= data.targetProduct ?></div>
        <? if (data.productName) { ?>
          <div class="summary-item" style="color: #555;"><?= data.productName ?></div>
        <? } ?>
        <div class="summary-item"><b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b> <?= data.quantity ?></div>
      </div>
    </div>
  </div>

  <!-- 2. –ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
  <div id="operationBox" class="operation-box">
    <span id="operationStatus" class="operation-status"></span>
    <span class="operation-name"><?= data.operationName ?></span>
    <div id="workTimer" style="position: absolute; top: 15px; right: 15px; font-size: 1.1em; color: #444;">
      <span>&#x23F0; </span>
      <span id="workTimerValue" style="font-weight: bold;"></span>
    </div>
  </div>

  <!-- 3. –ë–ª–æ–∫ "–ù–∞—á–∞–ª–æ, –ö–æ–Ω–µ—Ü, –†–∞–±–æ—Ç–Ω–∏–∫" -->
  <div class="action-block">
    <div id="lockedWarningBox" class="warning-box" style="margin: 0 0 15px 0; display: none; background-color: #ffcdd2; border-color: #c62828; color: #c62828;">
        –≠—Ç—É –¢–ö —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥—Ä—É–≥–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: <b id="assignedWorkerName"></b>
    </div>
    <div class="action-info">
      <div class="action-label">–ù–∞—á–∞–ª–æ:</div>
      <div class="action-value" id="startTime" style="font-weight: normal;"><?= data.formattedStartTime ?></div>
      
      <div class="action-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</div>
      <div class="action-value" id="lastChangeTime" style="font-weight: normal;"><?= data.formattedLastChangeTime ?></div>
      
      <div class="action-label">–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç:</div>
      <div class="action-value"><?= data.workerName ?></div>

      <div class="action-label">–î–æ—Å—Ç—É–ø—ã:</div>
      <div class="action-value" style="font-weight: normal; color: #555; font-size: 0.75em;"><?= data.userAccess ?></div>
    </div>
    <div id="buttonContainer" class="button-container">
      <div id="splitInputBlock" style="display: none; width: 100%; align-items: center; gap: 15px;">
        <span id="backFromSplitButton" style="font-size: 1.5em; color: #888; cursor: pointer;">&#9664;</span>
        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px; flex-grow: 1;">
            <span style="font-size: 1.1em;">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –Ω–æ–≤—É—é –¢–ö:</span>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="splitQuantityInput" style="width: 60px; font-size: 1.1em; padding: 5px; text-align: center; border-radius: 5px; border: 1px solid #ccc;">
                <span id="splitTotalQuantityLabel" style="font-size: 1.1em;"></span>
            </div>
        </div>
        <button id="confirmSplitButton" class="action-button" style="background-color: #a9d4d9; flex: 0 1 auto;">
            <span class="loader"></span>
            <span>–†–∞–∑–¥–µ–ª–∏—Ç—å</span>
        </button>
      </div>
      <div class="main-actions">
        <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-icon">üßπ</div>
  <div class="loading-text">—É–¥–∞–ª—è–µ–º —Ä–∞–±–æ—Ç—É</div>
</div>

  <script>
    // eslint-disable-next-line no-undef
    const data = <?!= JSON.stringify(data) ?>;
    let currentStatus = data.status;
    const hasAccess = data.hasAccess;
    const webAppUrl = data.webAppUrl; // –ü–æ–ª—É—á–∞–µ–º URL –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    /* eslint-enable */

    // --- CONFIG ---
    const statusConfig = {
      '–Ω–æ–≤–∞—è':    { text: '–ù–æ–≤–∞—è',    bgColor: '#EADCB9', textColor: '#8B795E' },
      '—Ä–∞–±–æ—Ç–∞':   { text: '–†–∞–±–æ—Ç–∞',   bgColor: '#E6BFBF', textColor: '#8B4545' },
      '–ø–∞—É–∑–∞':    { text: '–ü–∞—É–∑–∞',    bgColor: '#e0e0e0', textColor: '#616161' },
      '–≥–æ—Ç–æ–≤–æ':   { text: '–ì–æ—Ç–æ–≤–æ',   bgColor: '#B2D8B4', textColor: '#467448' },
      'no-access':{ text: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞', bgColor: '#ffebee', textColor: '#d32f2f' }
    };

    // --- UI ELEMENTS ---
    let ui;
    let timerInterval = null;

    // --- INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', function() {
      ui = {
        operationBox: document.getElementById('operationBox'),
        operationStatusEl: document.getElementById('operationStatus'),
        mainActionsContainer: document.querySelector('.main-actions'),
        secondaryActionsContainer: document.querySelector('.secondary-actions'),
        splitInputBlock: document.getElementById('splitInputBlock'),
        splitQuantityInput: document.getElementById('splitQuantityInput'),
        confirmSplitButton: document.getElementById('confirmSplitButton'),
        backFromSplitButton: document.getElementById('backFromSplitButton'),
        splitTotalQuantityLabel: document.getElementById('splitTotalQuantityLabel'),
        startTimeEl: document.getElementById('startTime'),
        lastChangeTimeEl: document.getElementById('lastChangeTime'),
        lockedWarningBox: document.getElementById('lockedWarningBox'),
        assignedWorkerName: document.getElementById('assignedWorkerName'),
        productPhoto: document.getElementById('product-photo'),
        photoPlaceholder: document.getElementById('photo-placeholder'),
        workTimer: document.getElementById('workTimer'),
        workTimerValue: document.getElementById('workTimerValue'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        mainContent: document.getElementById('mainContent')
      };
      
      // –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞
      if (data.canSplitTK) {
        ui.confirmSplitButton.addEventListener('click', handleSplit);
        ui.backFromSplitButton.addEventListener('click', hideSplitConfirmation);
      }
      
      // –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, —Ç–∞–∫ –∫–∞–∫ URL —É–∂–µ –µ—Å—Ç—å
      initializeApp();
    });

    function initializeApp() {
        if (!webAppUrl) {
            alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ –ø–æ–ø–∞–ø. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
            return;
        }

        if (data.isLockedByOtherUser) {
          showLockedWarning(data.assignedWorker);
        } else if (hasAccess) {
          updateUIForStatus(currentStatus);
        } else {
          showAccessWarning();
        }
        
        runAsAdmin('getProductPhotoBase64', [data.targetProduct])
          .then(onPhotoLoaded)
          .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', error);
            onPhotoLoaded(null);
          });
    }
    
    // --- UI UPDATE FUNCTIONS ---

    function updateUIForStatus(status) {
      currentStatus = status;
      updateStatusDisplay(status);
      updateButtons(status);
      updateTimer(status);
    }

    function updateStatusDisplay(status) {
      const config = statusConfig[status] || statusConfig['–Ω–æ–≤–∞—è'];
      ui.operationBox.style.backgroundColor = config.bgColor;
      ui.operationStatusEl.style.color = config.textColor;
      ui.operationStatusEl.textContent = config.text;
    }

    function updateButtons(status) {
      ui.mainActionsContainer.innerHTML = '';
      ui.splitInputBlock.style.display = 'none';
      ui.mainActionsContainer.style.display = 'flex';

      let buttonsHtml = '';
      const canSplit = data.canSplitTK;
      const hasOpAccess = data.hasAccess;
      const isLocked = data.isLockedByOtherUser;

      // 1. Add standard operation buttons if the user has access and the task is not locked
      if (!isLocked && hasOpAccess) {
        switch(status) {
          case '–Ω–æ–≤–∞—è':
            buttonsHtml += `<button id="startButton" class="action-button start-button">–ù–∞—á–∞—Ç—å</button>`;
            break;
          case '—Ä–∞–±–æ—Ç–∞':
            buttonsHtml += `<button id="pauseButton" class="action-button pause-button">–ü–∞—É–∑–∞</button><button id="finishButton" class="action-button finish-button">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`;
            break;
          case '–ø–∞—É–∑–∞':
            buttonsHtml += `<button id="resumeButton" class="action-button resume-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>`;
            break;
          case '–≥–æ—Ç–æ–≤–æ':
            buttonsHtml += `<button class="action-button" disabled>–ì–æ—Ç–æ–≤–æ</button>`;
            break;
        }
      }

      // 2. Add admin buttons if the user has '–†–¢–ö' rights
      if (canSplit) {
        if (status !== '–≥–æ—Ç–æ–≤–æ') {
          buttonsHtml += `<button id="splitButton" class="action-button" style="background-color: #A9D4D9;">–†–∞–∑–¥–µ–ª–∏—Ç—å</button>`;
        }
        buttonsHtml += `<button id="resetButton" class="action-button reset-button">–û–±–Ω—É–ª–∏—Ç—å</button>`;
      }

      ui.mainActionsContainer.innerHTML = buttonsHtml;
      attachButtonListeners();
    }

    function attachButtonListeners() {
      const startButton = document.getElementById('startButton');
      if (startButton) startButton.addEventListener('click', () => handleAction('start'));
      
      const pauseButton = document.getElementById('pauseButton');
      if (pauseButton) pauseButton.addEventListener('click', () => handleAction('pause'));

      const finishButton = document.getElementById('finishButton');
      if (finishButton) finishButton.addEventListener('click', () => handleAction('finish'));
      
      const resumeButton = document.getElementById('resumeButton');
      if (resumeButton) resumeButton.addEventListener('click', () => handleAction('resume'));

      const splitButton = document.getElementById('splitButton');
      if (splitButton) {
        splitButton.addEventListener('click', showSplitConfirmation);
      }

      const resetButton = document.getElementById('resetButton');
      if (resetButton) {
        resetButton.addEventListener('click', handleReset);
      }
    }

    function showSplitConfirmation() {
      ui.mainActionsContainer.style.display = 'none';
      ui.splitInputBlock.style.display = 'flex';
      const halfQuantity = Math.floor(data.quantity / 2);
      ui.splitQuantityInput.value = halfQuantity > 0 ? halfQuantity : 1;
      ui.splitQuantityInput.max = data.quantity - 1;
      ui.splitQuantityInput.min = 1;
      ui.splitTotalQuantityLabel.textContent = '–∏–∑ ' + data.quantity;
    }

    function hideSplitConfirmation() {
      ui.mainActionsContainer.style.display = 'flex';
      ui.splitInputBlock.style.display = 'none';
    }
    
    // --- ACTION HANDLER ---
    
    function runAsAdmin(functionName, args) {
      if (!webAppUrl) {
        return Promise.reject(new Error("URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω."));
      }

      return new Promise((resolve, reject) => {
        fetch(webAppUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          redirect: 'follow', // –í–∞–∂–Ω–æ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π Apps Script
          body: JSON.stringify({ functionName: functionName, args: args || [] })
        })
        .then(response => {
          if (!response.ok) {
            // –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å-–∫–æ–¥ HTTP, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —É—Å–ø–µ—à–Ω—ã–π
            throw new Error('–°–µ—Ç–µ–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–µ –±—ã–ª —É—Å–ø–µ—à–Ω—ã–º. –°—Ç–∞—Ç—É—Å: ' + response.status);
          }
          return response.json();
        })
        .then(result => {
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –Ω–∞—à–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞ –≤ doPost
          // –û–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ { success: true, data: { ... } }
          if (result.success && result.data !== undefined) {
             // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ —Å–≤–æ–π –æ–±—ä–µ–∫—Ç {success: ...}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
             // –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º '—Å—ã—Ä—ã–µ' –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ñ–æ—Ç–æ).
            if (typeof result.data === 'object' && result.data !== null && result.data.success === false) {
              reject(new Error(result.data.message || '–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–æ–±—â–∏–ª–∞ –æ–± –æ—à–∏–±–∫–µ.'));
            } else {
              resolve(result.data);
            }
          } else if (result.success === false) {
            // –≠—Ç–æ –æ—à–∏–±–∫–∞, –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω–∞—è —Å–∞–º–∏–º doPost (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏)
            reject(new Error(result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.'));
          } else {
            // –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
            reject(new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.'));
          }
        })
        .catch(error => {
            // –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –∞–ª–µ—Ä—Ç
            console.error('–û—à–∏–±–∫–∞ –≤ runAsAdmin:', error);
            reject(new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message));
        });
      });
    }

    function handleReset() {
        const confirmation = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å—é –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ—Ö –∫–∞—Ä—Ç–µ?");
        if (confirmation) {
            ui.mainContent.style.display = 'none';
            ui.loadingOverlay.style.display = 'flex';

            runAsAdmin('resetTKLog', [data.tkNumber])
                .then(result => {
                    // result –∑–¥–µ—Å—å —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç { success: true, ... }
                    google.script.host.close();
                })
                .catch(error => {
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + error.message);
                    ui.loadingOverlay.style.display = 'none';
                    ui.mainContent.style.display = 'block';
                });
        }
    }

    function handleSplit() {
        const quantityToMove = parseInt(ui.splitQuantityInput.value, 10);
        if (isNaN(quantityToMove) || quantityToMove < 1 || quantityToMove >= data.quantity) {
            alert(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (–æ—Ç 1 –¥–æ ${data.quantity - 1}).`);
            return;
        }

        setAllButtonsDisabled(true);
        const splitButton = document.getElementById('confirmSplitButton');
        const loader = splitButton.querySelector('.loader');
        if(loader) loader.style.display = 'inline-block';

        runAsAdmin('splitTK', [quantityToMove, data.activeRow])
            .then(result => {
                google.script.host.close();
            })
            .catch(error => {
                alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + error.message);
                if(loader) loader.style.display = 'none';
                setAllButtonsDisabled(false);
            });
    }

    function handleAction(action) {
        setAllButtonsDisabled(true);

        // –ü–µ—Ä–µ–¥–∞–µ–º 7 –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∫–∞–∫ –∏ –æ–∂–∏–¥–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        runAsAdmin('updateTKStatus', [
            action, 
            data.workerName, 
            data.tkNumber, 
            data.activeRow, 
            data.accumulatedWorkTimeMs, 
            data.lastChangeTimestamp, 
            currentStatus
        ])
            .then(result => {
                // result - —ç—Ç–æ { success: true, newStatus: '...', ... }
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                if (result.formattedStartTime) {
                    ui.startTimeEl.textContent = result.formattedStartTime;
                }
                if (result.formattedLastChangeTime) {
                    ui.lastChangeTimeEl.textContent = result.formattedLastChangeTime;
                }
                
                if (result.newAccumulatedWorkTimeMs !== undefined) {
                    data.accumulatedWorkTimeMs = result.newAccumulatedWorkTimeMs;
                }
                if (result.newLastChangeTimestamp) {
                    data.lastChangeTimestamp = result.newLastChangeTimestamp;
                }

                if (result.newStatus !== '–≥–æ—Ç–æ–≤–æ') {
                   ui.mainActionsContainer.style.display = 'flex';
                }
                updateUIForStatus(result.newStatus);
                setAllButtonsDisabled(false);
            })
            .catch(error => {
                alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + error.message);
                setAllButtonsDisabled(false);
            });
    }
    
    // --- UTILITY FUNCTIONS ---

    function setAllButtonsDisabled(disabled) {
      const buttons = document.querySelectorAll('.action-button');
      buttons.forEach(button => button.disabled = disabled);
    }

    function showLockedWarning(workerName) {
        ui.lockedWarningBox.style.display = 'block';
        ui.assignedWorkerName.textContent = workerName;
        updateUIForStatus(currentStatus);
    }

    function showAccessWarning() {
        updateStatusDisplay('no-access');
        ui.mainActionsContainer.innerHTML = '';
    }

    function onPhotoLoaded(photoBase64) {
      if (photoBase64 && photoBase64.startsWith('data:image/')) {
        ui.productPhoto.src = photoBase64;
        ui.productPhoto.style.display = 'block';
        ui.photoPlaceholder.style.display = 'none';
      } else {
        ui.productPhoto.style.display = 'none';
        ui.photoPlaceholder.style.display = 'block';
      }
    }

    function updateTimer(status) {
      if (timerInterval) clearInterval(timerInterval);
      
      ui.workTimer.style.display = 'block';

      const updateDisplay = (ms) => {
        ui.workTimerValue.textContent = formatMilliseconds(ms);
      };
      
      if (status === '—Ä–∞–±–æ—Ç–∞') {
        timerInterval = setInterval(() => {
          const elapsedMs = Date.now() - data.lastChangeTimestamp;
          const totalMs = data.accumulatedWorkTimeMs + elapsedMs;
          updateDisplay(totalMs);
        }, 1000);
      } else {
        updateDisplay(data.accumulatedWorkTimeMs);
      }
    }

    function formatMilliseconds(ms) {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        if (hours > 0) {
          return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else {
          return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }
  </script>
</body>
</html> 