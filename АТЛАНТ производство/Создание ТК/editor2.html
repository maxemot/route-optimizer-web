<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ö–µ–º —Å–±–æ—Ä–∫–∏</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: white;
    }
    
    .screen {
      display: none !important;
      width: 100%;
      height: 100vh;
      overflow: auto;
    }
    
    .screen.active {
      display: block !important;
    }
    
    /* –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –∏–∑–¥–µ–ª–∏—è */
    .products-screen {
      padding: 20px;
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    }
    
    .products-screen.active {
      display: block !important;
    }
    
    .search-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #45a049;
    }
    
    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #1976D2;
    }
    
    .btn-warning {
      background-color: #FF9800;
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #F57C00;
    }
    
    .btn:disabled {
      background-color: #cccccc;
      color: #666666;
      cursor: not-allowed;
    }
    
    .search-box {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      background: white;
    }
    
    .btn-add {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 25px;
      background-color: #4CAF50;
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    
    .btn-add:hover {
      background-color: #45a049;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }
    
    .product-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .product-card.selected {
      border: 3px solid #4CAF50;
    }
    
    .product-photo {
      width: 100%;
      height: 150px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .photo-icons {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .product-card:hover .photo-icons {
      opacity: 1;
    }
    
    .icon-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: transform 0.1s;
    }
    
    .icon-btn:hover {
      transform: scale(1.1);
    }
    
    .icon-btn.photo {
      background-color: rgba(33, 150, 243, 0.9);
      color: white;
    }
    
    .icon-btn.delete {
      background-color: rgba(244, 67, 54, 0.9);
      color: white;
    }
    
    .photo-loader {
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .photo-loaded {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .photo-loaded.visible {
      opacity: 1;
    }
    
    .product-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-photo.no-photo {
      background-color: #e9ecef;
      color: #6c757d;
      font-size: 14px;
    }
    
    .product-info {
      padding: 15px;
    }
    
    .product-code {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .product-name {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    
    .product-name:hover {
      background-color: #f0f0f0;
    }
    
    .product-name-input {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
      padding: 2px 4px;
      border: 1px solid #4CAF50;
      border-radius: 3px;
      background: white;
      width: 100%;
      box-sizing: border-box;
    }
    
    .product-name-loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 5px;
    }
    
    .editable {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    
    .editable:hover {
      background-color: #f0f0f0;
    }
    
    .editable-input {
      font-size: inherit;
      color: inherit;
      margin: 0;
      padding: 2px 4px;
      border: 1px solid #4CAF50;
      border-radius: 3px;
      background: white;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* –≠–∫—Ä–∞–Ω 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã */
    .editor-screen {
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
      flex-direction: column;
      height: 100vh;
    }
    
    .editor-screen.active {
      display: flex !important;
    }
    
    .editor-header {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .editor-title {
      font-size: 20px;
      font-weight: bold;
    }
    
    .editor-controls {
      display: flex;
      gap: 10px;
    }
    
    .editor-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
    }
    
    .cards-panel {
      flex: 1;
      background: none;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
      min-height: 400px;
    }
    
    .cards-header {
      background: #f8f9fa;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }
    
    .cards-content {
      padding: 0;
      /* max-height –∏ overflow —É–±—Ä–∞–Ω—ã –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
    }
    
    .current-node-panel {
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .current-node-content {
      display: flex;
      padding: 15px 20px;
      gap: 20px;
      align-items: center;
    }
    
    .current-node-photo {
      width: 160px;
      height: 120px;
      background-color: #e9ecef;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .current-node-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .current-node-photo.no-photo {
      color: #6c757d;
      font-size: 12px;
    }
    
    .current-node-info {
      flex: 1;
    }
    
    .current-node-code {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .current-node-name {
      font-size: 18px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .current-node-operation.editable {
      font-size: 16px;
      color: #333;
      padding: 4px;
      border-radius: 4px;
      display: block;
      width: 100%;
      font-style: normal;
      margin-bottom: 0;
    }
    
    .current-node-operation-block {
      background-color: #e3f2fd; /* Light blue */
      border: 1px solid #bbdefb; /* Slightly darker blue */
      border-radius: 8px;
      padding: 10px 15px;
      margin-left: auto; /* Pushes it to the right */
      text-align: left;
      min-width: 250px;
    }

    .current-node-operation-title {
      font-size: 12px;
      font-weight: 500;
      color: #0d47a1; /* Dark blue */
      margin-bottom: 4px;
    }
    
    .current-node-breadcrumb {
      font-size: 14px;
      color: #666;
    }
    
    .tree-node {
      margin-bottom: 5px;
    }
    
    .node-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 1px solid transparent;
    }
    
    .node-item:hover {
      background-color: #f8f9fa;
    }
    
    .node-item.selected {
      background-color: #e3f2fd;
      border-color: #2196F3;
    }
    
    .node-item.folder {
      font-weight: bold;
      background-color: #fff3e0;
    }
    
    .node-item.folder:hover {
      background-color: #ffe0b2;
    }
    
    .node-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    
    .node-photo {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      margin-right: 10px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .node-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .node-info {
      flex: 1;
    }
    
    .node-code {
      font-weight: bold;
      font-size: 14px;
    }
    
    .node-name {
      font-size: 12px;
      color: #666;
    }
    
    .node-quantity {
      margin-left: auto;
      font-size: 12px;
      color: #666;
      background-color: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .node-children {
      margin-left: 30px;
      display: none;
    }
    
    .node-children.expanded {
      display: block;
    }
    
    .properties-panel {
      width: 300px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .properties-header {
      background: #f8f9fa;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }
    
    .properties-content {
      padding: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    .photo-preview {
      width: 100%;
      max-width: 200px;
      height: 150px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview.no-photo {
      color: #6c757d;
      font-size: 12px;
      text-align: center;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* –õ–æ–∞–¥–µ—Ä */
    .loader {
      display: none;
      text-align: center;
      padding: 40px;
    }
    
    .loader.active {
      display: block;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .add-node-btn {
      width: 100%;
      padding: 10px;
      border: 2px dashed #ccc;
      background: none;
      border-radius: 5px;
      color: #666;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
    }
    
    .add-node-btn:hover {
      border-color: #4CAF50;
      color: #4CAF50;
    }
    
    .node-actions {
      margin-left: auto;
      display: flex;
      gap: 5px;
    }
    
    .node-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 3px;
      color: #666;
      font-size: 12px;
    }
    
    .node-action-btn:hover {
      background-color: #f0f0f0;
      color: #333;
    }
    
    .breadcrumb {
      padding: 10px 15px;
      font-size: 14px;
      color: #666;
    }
    
    .breadcrumb-link {
      color: #2196F3;
      cursor: pointer;
      text-decoration: none;
    }
    
    .breadcrumb-link:hover {
      text-decoration: underline;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      margin-top: 10px;
    }
    
    .error-message {
      color: #f44336;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #f44336;
      border-radius: 4px;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .add-card {
      border: 2px dashed #ccc;
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-card:hover {
      border-color: #4CAF50;
      color: #4CAF50;
      background-color: #f1f8e9;
    }

    .add-card-content span {
      font-size: 48px;
      font-weight: 200;
      line-height: 1;
    }

    .add-card-content p {
      margin: 10px 0 0;
      font-size: 14px;
    }

    .small-loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0d47a1; /* Dark blue to match title */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    .card-operation-tag {
      position: absolute;
      top: 5px;
      left: 5px;
      background: rgba(227, 242, 253, 0.9); /* Light blue, semi-transparent */
      color: #0d47a1; /* Dark blue */
      border: 1px solid #0d47a1;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px; /* –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 11px */
      font-weight: 500;
      max-width: calc(100% - 12px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <!-- –õ–æ–∞–¥–µ—Ä -->
  <div id="loader" class="loader">
    <div class="spinner"></div>
    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –∏–∑–¥–µ–ª–∏—è -->
  <div id="productsScreen" class="screen products-screen">
    <div class="search-section">
      <input type="text" class="search-box" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="filterProducts()">
      <button class="btn-add" onclick="createNewProduct()" title="–°–æ–∑–¥–∞—Ç—å –∏–∑–¥–µ–ª–∏–µ">+</button>
    </div>
    
    <div class="products-grid" id="productsGrid">
      <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã -->
  <div id="editorScreen" class="screen editor-screen">
    <div class="editor-header">
      <div>
        <span class="editor-title" id="editorTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã</span>
      </div>
    </div>
    
    <div class="editor-content">
      <!-- –ë–ª–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —É–∑–ª–æ–≤) -->
      <div id="currentNodePanel" class="current-node-panel" style="display: none;">
        <div class="current-node-content">
          <div class="current-node-photo" id="currentNodePhoto">
            <div class="photo-loader"></div>
          </div>
          <div class="current-node-info">
            <div class="current-node-code" id="currentNodeCode">–ö–æ–¥ —É–∑–ª–∞</div>
            <div class="current-node-name editable" id="currentNodeName" ondblclick="editCurrentNodeName()">–ù–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞</div>
            <div class="current-node-breadcrumb" id="currentNodeBreadcrumb">
              <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
            </div>
          </div>
          <div class="current-node-operation-block">
            <div class="current-node-operation-title">–û–ø–µ—Ä–∞—Ü–∏—è</div>
            <div class="current-node-operation editable" id="currentNodeOperation" ondblclick="editCurrentNodeOperation()">
              <span class="small-loader"></span>–ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
          </div>
        </div>
      </div>
      
      <!-- –ü–æ–∏—Å–∫ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —É–∑–ª–æ–≤ -->
      <div id="nodesSearchSection" class="search-section" style="display: none;">
        <input type="text" class="search-box" id="nodesSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="filterCards()">
        <button class="btn-add" onclick="addNewCard()" title="–°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç">+</button>
      </div>
      
      <div class="cards-panel">
        <div class="cards-content" id="cardsContent">
          <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–¥–µ–ª–∏—è -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="productModalTitle">–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª:</label>
          <input type="text" class="form-control" id="productCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª">
        </div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input type="text" class="form-control" id="productName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProductModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–∑–ª–∞ -->
  <div id="nodeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="nodeModalTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–∑–ª–∞</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–¢–∏–ø:</label>
          <select class="form-control" id="nodeType" onchange="onNodeTypeChange()">
            <option value="component">–î–µ—Ç–∞–ª—å</option>
            <option value="operation">–û–ø–µ—Ä–∞—Ü–∏—è</option>
            <option value="assembly">–£–∑–µ–ª (—Å–±–æ—Ä–∫–∞)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª/–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input type="text" class="form-control" id="nodeCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏">
        </div>
        <div class="form-group" id="sourceQuantityGroup">
          <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Ä–µ–º:</label>
          <input type="number" class="form-control" id="sourceQuantity" placeholder="1" min="1" step="0.01">
        </div>
        <div class="form-group" id="targetQuantityGroup">
          <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–∞–µ–º:</label>
          <input type="number" class="form-control" id="targetQuantity" placeholder="1" min="1" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input type="text" class="form-control" id="nodeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        </div>
        <div class="form-group">
          <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª —Ñ–æ—Ç–æ:</label>
          <input type="text" class="form-control" id="nodePhotoId" placeholder="–ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        </div>
        <div class="photo-preview" id="nodePhotoPreview">
          <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNodeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" onclick="saveNode()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–∞: –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –¥–æ 4-—Ö –∑–Ω–∞–∫–æ–≤, –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ.
     * @param {string|number} code - –ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.
     * @returns {string} –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª.
     */
    function normalizeCode(code) {
      if (code === null || code === undefined) return '';
      const strCode = String(code).trim();
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Å–æ—Å—Ç–æ—è—â–∞—è —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä, –¥–ª–∏–Ω–æ–π –æ—Ç 1 –¥–æ 4
      if (/^\d{1,4}$/.test(strCode)) {
        return strCode.padStart(4, '0');
      }
      return strCode; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è –Ω–µ—á–∏—Å–ª–æ–≤—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentCards = []; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ (–∏–∑–¥–µ–ª–∏—è –∏–ª–∏ —É–∑–ª—ã)
    let currentViewType = 'products'; // 'products' –∏–ª–∏ 'nodes'
    let currentFilterValue = null; // null –¥–ª—è –∏–∑–¥–µ–ª–∏–π, –∫–æ–¥ –∏–∑–¥–µ–ª–∏—è –¥–ª—è —É–∑–ª–æ–≤
    let currentSchema = [];
    let selectedNode = null;
    let editorImageCache = {};
    let productSchemaCache = {};
    
    // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    let screenCache = {}; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
    let searchCache = {}; // –ö—ç—à –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

    // –î–æ–±–∞–≤–ª—è–µ–º –∫—ç—à –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É–∑–ª–∞—Ö
    let nodeInfoCache = {};

    function showError(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function showLoading(show, message = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = overlay.querySelector('.loading-text');
      if (show) {
        loadingText.textContent = message;
        overlay.style.display = 'flex';
      } else {
        overlay.style.display = 'none';
      }
    }

    function initializeEditor() {
      showLoading(true, '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞...');
      
      // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
      if (initializationTimeout) {
        clearTimeout(initializationTimeout);
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
      initializationTimeout = setTimeout(() => {
        if (loadingRetries < MAX_RETRIES) {
          loadingRetries++;
          showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...');
          initializeEditor();
        } else {
          showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
          showLoading(false);
        }
      }, 30000);
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
      google.script.run
        .withSuccessHandler(function(products) {
          clearTimeout(initializationTimeout);
          loadingRetries = 0;
          
          if (!products || products.length === 0) {
            showError('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π');
            showLoading(false);
            return;
          }
          
          // –ö—ç—à–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
          screenCache['products_root'] = {
            cards: products,
            timestamp: Date.now()
          };
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          renderProducts(products);
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          clearTimeout(initializationTimeout);
          
          if (loadingRetries < MAX_RETRIES) {
            loadingRetries++;
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...');
            setTimeout(initializeEditor, RETRY_DELAY);
          } else {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            showLoading(false);
          }
        })
        .getProductsList();
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
      document.getElementById('editorScreen').classList.remove('active');
      document.getElementById('editorScreen').style.display = 'none';
      document.getElementById('loader').classList.remove('active');
      document.getElementById('loader').style.display = 'none';

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Ä–∞–Ω —Å–æ —Å–ø–∏—Å–∫–æ–º –∏–∑–¥–µ–ª–∏–π
      document.getElementById('productsScreen').classList.add('active');
      document.getElementById('productsScreen').style.display = 'block';

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–∫—Ä–∞–Ω –∏–∑–¥–µ–ª–∏–π
      initializeScreen('products', null);
    };

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ===

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
    function initializeScreen(viewType, filterValue) {
      currentViewType = viewType;
      currentFilterValue = filterValue;
      
      console.log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞: ${viewType}, —Ñ–∏–ª—å—Ç—Ä: ${filterValue}`);
      
      // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —ç–∫—Ä–∞–Ω–æ–≤
      if (viewType === 'products') {
        loadingPhotos.clear();
      }
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      let container;
      if (viewType === 'products') {
        container = document.getElementById('productsGrid');
        // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —ç–∫—Ä–∞–Ω–∞ —É–∑–ª–æ–≤
        document.getElementById('currentNodePanel').style.display = 'none';
        document.getElementById('nodesSearchSection').style.display = 'none';
      } else {
        container = document.getElementById('cardsContent');
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —É–∑–ª–æ–≤
        document.querySelector('.editor-header').style.display = 'none';
        document.getElementById('currentNodePanel').style.display = 'block';
        document.getElementById('nodesSearchSection').style.display = 'none';
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —É–∑–ª–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–ª–æ–∫ –µ—â–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
        const currentNodeCode = document.getElementById('currentNodeCode').textContent;
        if (!currentNodeCode || currentNodeCode === '–ö–æ–¥ —É–∑–ª–∞') {
          updateCurrentNodeInfo();
        }
      }
      
      if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –∫—ç—à–∞
      const cacheKey = `${viewType}_${filterValue || 'root'}`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
      if (screenCache[cacheKey]) {
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫—ç—à–∞: ${cacheKey}`);
        const cachedData = screenCache[cacheKey];
        currentCards = cachedData.cards;
        renderCards(container, cachedData.cards);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ—Ç–æ —Å—Ä–∞–∑—É –∏–∑ –∫—ç—à–∞ (–±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏)
        cachedData.cards.forEach(card => {
          const photoId = card.photoId || card.code;
          if (editorImageCache[photoId]) {
            updateCardPhotoDisplay(card.code, editorImageCache[photoId], card.hasChildren);
          }
        });
        
        // –ï—Å–ª–∏ –≤ –∫—ç—à–µ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (cachedData.cards.length === 0) {
          if (viewType === 'products') {
            container.innerHTML = `
              <div style="text-align: center; padding: 60px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">üì¶</div>
                <h3>–ò–∑–¥–µ–ª–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–¥–µ–ª–∏–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É "+" —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–∏—Å–∫–∞</p>
              </div>
            `;
          } else {
            container.innerHTML = `
              <div style="text-align: center; padding: 60px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">üîß</div>
                <h3>–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–í –¥–∞–Ω–Ω–æ–º –∏–∑–¥–µ–ª–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</p>
                <button class="btn btn-primary" onclick="addNewCard()" style="margin-top: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
              </div>
            `;
          }
          updateSearchPlaceholder();
          return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç –≤ –∫—ç—à–µ
        const cardsNeedingPhotos = cachedData.cards.filter(card => {
          const photoId = card.photoId || card.code;
          return !editorImageCache[photoId] && !loadingPhotos.has(photoId);
        });
        
        if (cardsNeedingPhotos.length > 0) {
          console.log(`–î–æ–≥—Ä—É–∂–∞–µ–º ${cardsNeedingPhotos.length} —Ñ–æ—Ç–æ –∏–∑ ${cachedData.cards.length}`);
          loadCardsPhotosProgressively(cardsNeedingPhotos);
        }
        
        updateSearchPlaceholder();
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω—ã
      renderSkeletons(container);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const runner = google.script.run
        .withSuccessHandler(function(cards) {
          console.log(`–ü–æ–ª—É—á–µ–Ω–æ ${cards.length} –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–∏–ø–∞ ${viewType}`);
          currentCards = cards;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
          screenCache[cacheKey] = {
            cards: cards,
            timestamp: Date.now()
          };
          
          // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if (cards.length === 0) {
            if (viewType === 'products') {
              container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 20px;">üì¶</div>
                  <h3>–ò–∑–¥–µ–ª–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                  <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–¥–µ–ª–∏–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É "+" —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–∏—Å–∫–∞</p>
                </div>
              `;
            } else {
              container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 20px;">üîß</div>
                  <h3>–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                  <p>–í –¥–∞–Ω–Ω–æ–º –∏–∑–¥–µ–ª–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</p>
                  <button class="btn btn-primary" onclick="addNewCard()" style="margin-top: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
                </div>
              `;
            }
            updateSearchPlaceholder();
            return;
          }
          
          renderCards(container, cards);
          
          // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ
          loadCardsPhotosProgressively(cards);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø–æ–∏—Å–∫–∞
          updateSearchPlaceholder();
        })
        .withFailureHandler(function(error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫:', error);
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #f44336;">
              <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>
              <button class="btn btn-primary" onclick="initializeScreen('${viewType}', '${filterValue}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
          `;
        });

      if (viewType === 'nodes') {
        const rootCode = getRootProductCode();
        console.log(`–ó–∞–ø—Ä–æ—Å —É–∑–ª–æ–≤ –¥–ª—è ${filterValue} –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ${rootCode}`);
        runner.getCardsFast(viewType, filterValue, rootCode);
      } else {
        runner.getCardsFast(viewType, filterValue, null);
      }
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–∫–µ–ª–µ—Ç–æ–Ω–æ–≤
    function renderSkeletons(container) {
      if (currentViewType === 'products') {
        container.innerHTML = Array(3).fill(0).map(() => createCardSkeleton()).join('');
      } else {
        container.innerHTML = `
          <div class="products-grid" style="padding: 15px;">
            ${Array(2).fill(0).map(() => createCardSkeleton()).join('')}
          </div>
          <div style="padding: 15px;">
            <button class="add-node-btn" onclick="addNewCard()">+ –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
          </div>
        `;
      }
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    function renderCards(container, cards) {
      if (currentViewType === 'products') {
        container.innerHTML = cards.map(card => createUniversalCard(card)).join('');
      } else {
        const cardsHtml = cards.map(card => createUniversalCard(card)).join('');
        // –î–ª—è —ç–∫—Ä–∞–Ω–∞ —É–∑–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–∫—É—é –∂–µ —Å–µ—Ç–∫—É –∫–∞–∫ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤
        container.innerHTML = `
          <div class="products-grid">
            ${cardsHtml}
            <div class="product-card add-card" onclick="addNewCard()">
              <div class="add-card-content">
                <span>+</span>
                <p>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</p>
              </div>
            </div>
          </div>
        `;
      }
    }

    function goToProductsScreen() {
      // –Ø–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
      document.getElementById('editorScreen').classList.remove('active');
      document.getElementById('editorScreen').style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å–æ —Å–ø–∏—Å–∫–æ–º –∏–∑–¥–µ–ª–∏–π
      document.getElementById('productsScreen').classList.add('active');
      document.getElementById('productsScreen').style.display = 'block';
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const modalTitle = document.querySelector('.modal-dialog .modal-title') || document.querySelector('title');
      if (modalTitle) {
        modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ö–µ–º —Å–±–æ—Ä–∫–∏';
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.value = '';
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–∫—Ä–∞–Ω –∏–∑–¥–µ–ª–∏–π
      initializeScreen('products', null);
      
      currentSchema = [];
      currentLevel = [];
      clearSelection();
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    function createCardSkeleton() {
      return `
        <div class="product-card">
          <div class="product-photo">
            <div class="photo-loader"></div>
          </div>
          <div class="product-info">
            <div class="product-code">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="product-name">–ü–æ–∏—Å–∫...</div>
          </div>
        </div>
      `;
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    function createUniversalCard(card) {
      const hasChildrenIcon = card.hasChildren ? 'üìÅ' : 'üìÑ';
      const quantityText = card.type === 'node' && !card.isOperation ? `${card.quantity} —à—Ç` : '';
      const photoId = card.photoId || card.code;
      
      let photoContent = '';
      let photoClasses = 'product-photo';

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ü–†–ò –°–û–ó–î–ê–ù–ò–ò –∫–∞—Ä—Ç–æ—á–∫–∏
      if (photoId in editorImageCache) {
        const cachedImage = editorImageCache[photoId];
        if (cachedImage) {
          photoContent = `<img class="photo-loaded visible" src="${cachedImage}" alt="${card.code}">`;
        } else {
          photoContent = `<span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>`;
          photoClasses += ' no-photo';
        }
      } else {
        // –ï—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        photoContent = `<div class="photo-loader"></div>`;
      }
      
      let overlayContent = '';
      if (card.type === 'node' && card.hasChildren) {
        overlayContent = `<div class="card-operation-tag" id="operation-tag-${card.code}">–∑–∞–≥—Ä—É–∑–∫–∞...</div>`;
      }
      
      return `
        <div class="product-card" data-card-code="${card.code}" data-card-type="${card.type}"
             ondblclick="handleCardDoubleClick('${card.code}', '${card.type}')" 
             onclick="handleCardClick('${card.code}', '${card.type}')">
          <div class="${photoClasses}" id="photo-${card.code}">
            ${photoContent}
            ${overlayContent}
            <div class="photo-icons">
              ${card.type === 'node' ? `<button class="icon-btn photo" onclick="event.stopPropagation(); editPhotoId('${card.code}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>` : ''}
              <button class="icon-btn delete" onclick="event.stopPropagation(); deleteCard('${card.code}', '${card.type}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          </div>
          <div class="product-info">
            <div class="product-code">${card.code}</div>
            <div class="product-name editable" ondblclick="event.stopPropagation(); editCardName('${card.code}', this)">${card.name}</div>
            ${quantityText ? `<div class="editable" style="font-size: 12px; color: #666; margin-top: 5px;" ondblclick="event.stopPropagation(); editCardQuantity('${card.code}', this)">${quantityText}</div>` : ''}
          </div>
        </div>
      `;
    }

    function goToEditorScreen(card) {
      // –Ø–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ –∏–∑–¥–µ–ª–∏–π
      document.getElementById('productsScreen').classList.remove('active');
      document.getElementById('productsScreen').style.display = 'none';

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
      document.getElementById('editorScreen').classList.add('active');
      document.getElementById('editorScreen').style.display = 'block';

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–ø–∞–ø–∞
      const modalTitle = document.querySelector('.modal-dialog .modal-title') || document.querySelector('title');
      if (modalTitle) {
        modalTitle.textContent = `${card.code} - ${card.name}`;
      }
      document.getElementById('editorTitle').textContent = `${card.code} - ${card.name}`;

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      currentLevel = [];
      currentFilterValue = card.code;

      // –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∫–µ—à–µ, –Ω–µ –∑–∞—Ç–∏—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—é
      if (!nodeInfoCache[card.code]) {
        nodeInfoCache[card.code] = {};
      }
      Object.assign(nodeInfoCache[card.code], {
        code: card.code,
        name: card.name,
        photoId: card.photoId || card.code
      });

      if (card.photoUrl) {
        editorImageCache[card.photoId || card.code] = card.photoUrl;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ —É–∂–µ —Å—Ö–µ–º–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∏–∑–¥–µ–ª–∏—è
      if (productSchemaCache[card.code]) {
        console.log(`–°—Ö–µ–º–∞ –¥–ª—è ${card.code} —É–∂–µ –≤ –∫—ç—à–µ.`);
        currentSchema = productSchemaCache[card.code]; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ö–µ–º—É
        updateCurrentNodeInfoFromCard(card, false);    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ-–±–ª–æ–∫ –±–µ–∑ –ª–æ–∞–¥–µ—Ä–∞
        initializeScreen('nodes', card.code);
        setTimeout(updateOperationTags, 50);          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–≥–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        return; // –ó–∞–≤–µ—Ä—à–∞–µ–º, —Ç.–∫. –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
      }

      // –ï—Å–ª–∏ —Å—Ö–µ–º—ã –≤ –∫—ç—à–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      updateCurrentNodeInfoFromCard(card, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏
      initializeScreen('nodes', card.code);

      // –í –§–û–ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ö–µ–º—É –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('–ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ.');
          currentSchema = result.schema;
          productSchemaCache[card.code] = result.schema; // –ö–ï–®–ò–†–£–ï–ú –°–•–ï–ú–£
          
          // –î–æ–ø–æ–ª–Ω—è–µ–º –∫—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã
          editorImageCache = { ...editorImageCache, ...result.images };

          // –ö–µ—à–∏—Ä—É–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ö–µ–º—ã
          if (currentSchema) {
            currentSchema.forEach(item => {
              if (item.target) {
                // –ï—Å–ª–∏ –¥–ª—è —É–∑–ª–∞ –µ—â–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –∫–µ—à–µ, —Å–æ–∑–¥–∞–µ–º –µ–µ
                if (!nodeInfoCache[item.target]) {
                  nodeInfoCache[item.target] = { code: item.target, name: item.targetName };
                }
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∫–µ—à
                nodeInfoCache[item.target].operation = item.operation;
              }
            });
          }

          // –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –∫–µ—à –∑–∞–ø–æ–ª–Ω–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —É–∑–µ–ª (isSchemaLoading = false)
          updateCurrentNodeInfoFromCard(card, false);
          // –ò –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–≥–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
          updateOperationTags();
        })
        .withFailureHandler(function(error) {
          console.error('–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã:', error);
          const operationElement = document.getElementById('currentNodeOperation');
          if (operationElement) {
            operationElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            operationElement.classList.remove('editable');
            operationElement.ondblclick = null;
          }
        })
        .loadFullSchemaForProduct(card.code);
    }

    // === –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ
    function handleCardDoubleClick(cardCode, cardType) {
      if (cardType === 'product') {
        const card = currentCards.find(c => c.code === cardCode);
        if (card) {
          goToEditorScreen(card);
        }
      } else if (cardType === 'node') {
        const card = currentCards.find(c => c.code === cardCode);
        if (card && card.hasChildren) {
          // –ò—â–µ–º –≤ –∫—ç—à–µ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —É–∑–ª–µ
          const parentCard = currentCards.find(c => c.code === currentFilterValue);
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏, –¥–æ–±–∞–≤–ª—è—è —Ç–µ–∫—É—â–∏–π —É–∑–µ–ª –≤ –ø—É—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –∫–æ—Ä–Ω–µ–≤–æ–π
          if (currentFilterValue !== getRootProductCode()) {
            currentLevel.push({
              code: currentFilterValue,
              name: (parentCard ? parentCard.name : document.getElementById('currentNodeName').textContent) || currentFilterValue,
              card: parentCard || { code: currentFilterValue, name: document.getElementById('currentNodeName').textContent }
            });
          }
          currentFilterValue = cardCode;
          
          // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∏
          updateCurrentNodeInfoFromCard(card);
          
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–æ—á–µ—Ä–Ω–∏–π —É–∑–µ–ª
          initializeScreen('nodes', cardCode);
        }
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ
    function handleCardClick(cardCode, cardType) {
      // –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
    function editCardName(cardCode, nameElement) {
      const currentName = nameElement.textContent;
      const input = document.createElement('input');
      input.className = 'editable-input';
      input.value = currentName;
      input.maxLength = 100;
      
      nameElement.parentNode.replaceChild(input, nameElement);
      input.focus();
      input.select();
      
      const saveEdit = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          const loaderDiv = document.createElement('div');
          loaderDiv.className = 'product-name editable';
          loaderDiv.innerHTML = newName + '<span class="product-name-loader"></span>';
          loaderDiv.ondblclick = (e) => { e.stopPropagation(); editCardName(cardCode, loaderDiv); };
          input.parentNode.replaceChild(loaderDiv, input);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          if (currentViewType === 'products') {
            google.script.run
              .withSuccessHandler(function(result) {
                handleNameUpdateResult(result, cardCode, newName, currentName, loaderDiv);
              })
              .withFailureHandler(function(error) {
                handleNameUpdateError(error, cardCode, currentName, loaderDiv);
              })
              .renameProduct(cardCode, newName);
          } else {
            // –î–ª—è —É–∑–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É
            updateNodeNameInSchema(cardCode, newName);
            handleNameUpdateResult({success: true}, cardCode, newName, currentName, loaderDiv);
          }
        } else {
          // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          restoreNameElement(input, cardCode, currentName);
        }
      };
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          restoreNameElement(input, cardCode, currentName);
        }
      });
      
      input.addEventListener('blur', saveEdit);
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–∑–ª–∞ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
    function editCardQuantity(cardCode, quantityElement) {
      const currentQuantity = quantityElement.textContent.replace(' —à—Ç', '');
      const input = document.createElement('input');
      input.className = 'editable-input';
      input.type = 'number';
      input.value = currentQuantity;
      input.min = '0.01';
      input.step = '0.01';
      
      quantityElement.parentNode.replaceChild(input, quantityElement);
      input.focus();
      input.select();
      
      const saveEdit = () => {
        const newQuantity = parseFloat(input.value);
        if (newQuantity && newQuantity !== parseFloat(currentQuantity)) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É
          updateNodeQuantityInSchema(cardCode, newQuantity);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
          const newElement = document.createElement('div');
          newElement.className = 'editable';
          newElement.style.cssText = 'font-size: 12px; color: #666; margin-top: 5px;';
          newElement.textContent = `${newQuantity} —à—Ç`;
          newElement.ondblclick = (e) => { e.stopPropagation(); editCardQuantity(cardCode, newElement); };
          input.parentNode.replaceChild(newElement, input);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤–µ –∫–∞—Ä—Ç–æ—á–µ–∫
          const card = currentCards.find(c => c.code === cardCode);
          if (card) {
            card.quantity = newQuantity;
          }
          
          autoSaveSchema();
        } else {
          // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          restoreQuantityElement(input, cardCode, currentQuantity);
        }
      };
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          restoreQuantityElement(input, cardCode, currentQuantity);
        }
      });
      
      input.addEventListener('blur', saveEdit);
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function handleNameUpdateResult(result, cardCode, newName, currentName, loaderDiv) {
      if (result.success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫—ç—à–µ
        const card = currentCards.find(c => c.code === cardCode);
        if (card) {
          card.name = newName;
        }
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à –µ—Å–ª–∏ —ç—Ç–æ –∏–∑–¥–µ–ª–∏–µ
        if (currentViewType === 'products') {
          invalidateCache('products', null);
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π div
        restoreNameElement(loaderDiv, cardCode, newName);
      } else {
        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ' + result.error);
        restoreNameElement(loaderDiv, cardCode, currentName);
      }
    }
    
    function handleNameUpdateError(error, cardCode, currentName, loaderDiv) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
      restoreNameElement(loaderDiv, cardCode, currentName);
    }
    
    function restoreNameElement(inputOrLoader, cardCode, name) {
      const nameDiv = document.createElement('div');
      nameDiv.className = 'product-name editable';
      nameDiv.ondblclick = (e) => { e.stopPropagation(); editCardName(cardCode, nameDiv); };
      nameDiv.textContent = name;
      inputOrLoader.parentNode.replaceChild(nameDiv, inputOrLoader);
    }
    
    function restoreQuantityElement(input, cardCode, quantity) {
      const quantityDiv = document.createElement('div');
      quantityDiv.className = 'editable';
      quantityDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 5px;';
      quantityDiv.textContent = `${quantity} —à—Ç`;
      quantityDiv.ondblclick = (e) => { e.stopPropagation(); editCardQuantity(cardCode, quantityDiv); };
      input.parentNode.replaceChild(quantityDiv, input);
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ç–∏–∫—É–ª–∞ —Ñ–æ—Ç–æ
    function editPhotoId(cardCode) {
      const card = currentCards.find(c => c.code === cardCode);
      if (!card) return;
      
      const currentPhotoId = card.photoId || cardCode;
      const newPhotoId = prompt('–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ:', currentPhotoId);
      
      if (newPhotoId !== null && newPhotoId !== currentPhotoId) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Å—Ö–µ–º–µ
        updateNodePhotoInSchema(cardCode, newPhotoId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫—ç—à–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        card.photoId = newPhotoId;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
        loadSingleCardPhoto(card);
        
        autoSaveSchema();
      }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    function deleteCard(cardCode, cardType) {
      const card = currentCards.find(c => c.code === cardCode);
      if (!card) return;
      
      const confirmMessage = cardType === 'product' 
        ? `–£–¥–∞–ª–∏—Ç—å –∏–∑–¥–µ–ª–∏–µ "${cardCode}"?\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å—é —Å—Ö–µ–º—É —Å–±–æ—Ä–∫–∏ –∏–∑–¥–µ–ª–∏—è!`
        : `–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç "${cardCode}"?\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç —ç–ª–µ–º–µ–Ω—Ç –∏ –≤—Å–µ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã!`;
      
      if (confirm(confirmMessage)) {
        if (cardType === 'product') {
          // –£–¥–∞–ª—è–µ–º –∏–∑–¥–µ–ª–∏–µ
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                invalidateCache('products', null);
                initializeScreen('products', null); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
              } else {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + result.error);
              }
            })
            .withFailureHandler(function(error) {
              alert('–û—à–∏–±–∫–∞: ' + error.message);
            })
            .deleteProduct(cardCode);
        } else {
          // –£–¥–∞–ª—è–µ–º —É–∑–µ–ª –∏–∑ —Å—Ö–µ–º—ã
          deleteNodeRecursive(cardCode);
          autoSaveSchema();
          // –û—á–∏—â–∞–µ–º –∫—ç—à —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
          invalidateCache('nodes', currentFilterValue);
          initializeScreen('nodes', currentFilterValue); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
        }
      }
    }

    function loadProducts() {
      console.log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–¥–µ–ª–∏–π...');
      invalidateCache('products', null);
      initializeScreen('products', null);
    }

    function renderProducts(products) {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      
      products.forEach(product => {
        const card = createProductCard(product);
        grid.appendChild(card);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø–æ–∏—Å–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
      updateSearchPlaceholder();
    }
    
    function updateSearchPlaceholder() {
      let searchInput;
      if (currentViewType === 'products') {
        searchInput = document.getElementById('searchInput');
      } else {
        searchInput = document.getElementById('nodesSearchInput');
      }
      
      if (!searchInput) return;
      
      const totalCount = currentCards.length;
      const visibleCount = document.querySelectorAll('.product-card').length;
      const itemType = currentViewType === 'products' ? '–∏–∑–¥–µ–ª–∏–π' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤';
      
      if (totalCount === visibleCount) {
        searchInput.placeholder = `–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–∑ ${totalCount} ${itemType}...`;
      } else {
        searchInput.placeholder = `–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é (–ø–æ–∫–∞–∑–∞–Ω–æ ${visibleCount} –∏–∑ ${totalCount})...`;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    function invalidateCache(viewType, filterValue) {
      const cacheKey = `${viewType}_${filterValue || 'root'}`;
      delete screenCache[cacheKey];
      
      // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –∫—ç—à —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–∏—Ö
      if (filterValue) {
        // –û—á–∏—â–∞–µ–º –∫—ç—à –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç
        Object.keys(screenCache).forEach(key => {
          if (key.startsWith('nodes_') && key !== cacheKey) {
            delete screenCache[key];
          }
        });
      }
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ö–µ–º–æ–π
    function updateNodeNameInSchema(cardCode, newName) {
      if (!currentSchema) return;
      
      currentSchema.forEach(item => {
        if (item.source === cardCode && item.target === currentFilterValue) {
          item.sourceName = newName;
        }
      });
    }
    
    function updateNodeQuantityInSchema(cardCode, newQuantity) {
      if (!currentSchema) return;
      
      currentSchema.forEach(item => {
        if (item.source === cardCode && item.target === currentFilterValue) {
          item.sourceQuantity = newQuantity;
        }
      });
    }
    
    function updateNodePhotoInSchema(cardCode, newPhotoId) {
      if (!currentSchema) return;
      
      currentSchema.forEach(item => {
        if (item.source === cardCode && item.target === currentFilterValue) {
          item.sourcePhotoId = newPhotoId;
        }
      });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    function addNewCard() {
      if (currentViewType === 'products') {
        createNewProduct();
      } else {
        addNewNode();
      }
    }
    
    function addNewNode() {
      selectedNode = { type: 'new', parent: currentFilterValue };
      openNodeModal('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.ondblclick = () => goToEditorScreen(product);
      
      // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –¥–ª—è –∏–∑–¥–µ–ª–∏—è
      const photoUrl = getImageFromCache(product.photoId || product.code);
      
      card.innerHTML = `
        <div class="product-photo ${!photoUrl ? 'no-photo' : ''}">
          ${photoUrl ? `<img src="${photoUrl}" alt="${product.code}">` : '–ù–µ—Ç —Ñ–æ—Ç–æ'}
        </div>
        <div class="product-info">
          <div class="product-code">${product.code}</div>
          <div class="product-name" ondblclick="event.stopPropagation(); startNameEdit('${product.code}', this)">${product.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
        </div>
      `;
      
      return card;
    }
    
    function createProductCardFast(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.setAttribute('data-product-code', product.code);
      card.ondblclick = () => goToEditorScreen(product);
      
      card.innerHTML = `
        <div class="product-photo" id="photo-${product.code}">
          <div class="photo-loader"></div>
        </div>
        <div class="product-info">
          <div class="product-code">${product.code}</div>
          <div class="product-name" ondblclick="event.stopPropagation(); startNameEdit('${product.code}', this)">${product.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
        </div>
      `;
      
      return card;
    }
    
    function renderProductsFast(products) {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      
      products.forEach(product => {
        const card = createProductCardFast(product);
        grid.appendChild(card);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø–æ–∏—Å–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
      updateSearchPlaceholder();
    }
    
    function loadPhotosProgressively() {
      const photosToLoad = currentProducts.filter(p => !editorImageCache[p.photoId]);
      console.log(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É ${photosToLoad.length} —Ñ–æ—Ç–æ...`);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      photosToLoad.forEach((product, index) => {
        setTimeout(() => {
          loadSingleProductPhoto(product);
        }, index * 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ 100–º—Å –º–µ–∂–¥—É –∑–∞–≥—Ä—É–∑–∫–∞–º–∏
      });
    }
    
    // –û–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–æ—Ç–æ
    const loadingPhotos = new Set();
    
    function loadSingleCardPhoto(card) {
      const photoId = card.photoId || card.code;
      
      // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –≤ –∫—ç—à–µ (–∏–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ –µ–≥–æ –Ω–µ—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –∑–Ω–∞–Ω–∏–µ
      if (photoId in editorImageCache) {
        updateCardPhotoDisplay(card.code, editorImageCache[photoId], card.hasChildren);
        return;
      }
      
      // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
      if (loadingPhotos.has(photoId)) {
        // –ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –≤ –∫—ç—à–µ —É–∂–µ –µ—Å—Ç—å
        setTimeout(() => {
          if (photoId in editorImageCache) {
            updateCardPhotoDisplay(card.code, editorImageCache[photoId], card.hasChildren);
          }
        }, 100);
        return;
      }
      
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –¥–ª—è ${card.code} (photoId: ${photoId})`);
      loadingPhotos.add(photoId);
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ
      // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ - —ç—Ç–æ —É–∑–µ–ª ('node'), –∏—â–µ–º –≤ –ø–∞–ø–∫–µ –∏–∑–¥–µ–ª–∏—è.
      // –ò–Ω–∞—á–µ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ 'product') –∏—â–µ–º –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ.
      const productCodeContext = card.type === 'node' ? getRootProductCode() : null;
      
      google.script.run
        .withSuccessHandler(function(imageData) {
          loadingPhotos.delete(photoId);
          
          // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç: imageData (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ null (–µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç)
          editorImageCache[photoId] = imageData;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —ç—Ç–∏–º photoId
          currentCards.forEach(c => {
            if ((c.photoId || c.code) === photoId) {
              updateCardPhotoDisplay(c.code, imageData, c.hasChildren);
            }
          });
        })
        .withFailureHandler(function(error) {
          loadingPhotos.delete(photoId);
          console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ${photoId}:`, error);
          // –ö—ç—à–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          editorImageCache[photoId] = null;
          updateCardPhotoDisplay(card.code, null, card.hasChildren);
        })
        .getProductPhotoBase64(photoId, productCodeContext);
    }
    
    function updateProductPhoto(productCode, imageData) {
      const photoContainer = document.getElementById(`photo-${productCode}`);
      if (!photoContainer) return;
      
      if (imageData) {
        photoContainer.innerHTML = `<img class="photo-loaded visible" src="${imageData}" alt="${productCode}">`;
      } else {
        photoContainer.innerHTML = '<span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>';
        photoContainer.classList.add('no-photo');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
    function startNameEdit(productCode, nameElement) {
      const currentName = nameElement.textContent;
      const input = document.createElement('input');
      input.className = 'product-name-input';
      input.value = currentName;
      input.maxLength = 100;
      
      // –ó–∞–º–µ–Ω—è–µ–º div –Ω–∞ input
      nameElement.parentNode.replaceChild(input, nameElement);
      input.focus();
      input.select();
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const saveEdit = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          const loaderDiv = document.createElement('div');
          loaderDiv.className = 'product-name editable';
          loaderDiv.innerHTML = newName + '<span class="product-name-loader"></span>';
          input.parentNode.replaceChild(loaderDiv, input);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          if (currentViewType === 'products') {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫—ç—à–µ
                  const product = currentProducts.find(p => p.code === productCode);
                  if (product) {
                    product.name = newName;
                  }
                  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π div
                  const newNameDiv = document.createElement('div');
                  newNameDiv.className = 'product-name';
                  newNameDiv.ondblclick = (e) => { e.stopPropagation(); startNameEdit(productCode, newNameDiv); };
                  newNameDiv.textContent = newName;
                  loaderDiv.parentNode.replaceChild(newNameDiv, loaderDiv);
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ' + result.error);
                  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                  const originalDiv = document.createElement('div');
                  originalDiv.className = 'product-name';
                  originalDiv.ondblclick = (e) => { e.stopPropagation(); startNameEdit(productCode, originalDiv); };
                  originalDiv.textContent = currentName;
                  loaderDiv.parentNode.replaceChild(originalDiv, loaderDiv);
                }
              })
              .withFailureHandler(function(error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                const originalDiv = document.createElement('div');
                originalDiv.className = 'product-name';
                originalDiv.ondblclick = (e) => { e.stopPropagation(); startNameEdit(productCode, originalDiv); };
                originalDiv.textContent = currentName;
                loaderDiv.parentNode.replaceChild(originalDiv, loaderDiv);
              })
              .renameProduct(productCode, newName);
          } else {
            // –î–ª—è —É–∑–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É
            updateNodeNameInSchema(cardCode, newName);
            handleNameUpdateResult({success: true}, cardCode, newName, currentName, loaderDiv);
          }
        } else {
          // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          const originalDiv = document.createElement('div');
          originalDiv.className = 'product-name';
          originalDiv.ondblclick = (e) => { e.stopPropagation(); startNameEdit(productCode, originalDiv); };
          originalDiv.textContent = currentName;
          input.parentNode.replaceChild(originalDiv, input);
        }
      };
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏—à
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          // –û—Ç–º–µ–Ω–∞
          const originalDiv = document.createElement('div');
          originalDiv.className = 'product-name';
          originalDiv.ondblclick = (e) => { e.stopPropagation(); startNameEdit(productCode, originalDiv); };
          originalDiv.textContent = currentName;
          input.parentNode.replaceChild(originalDiv, input);
        }
      });
      
      // –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞ = —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      input.addEventListener('blur', saveEdit);
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    function loadCardsPhotosProgressively(cards) {
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ photoId —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–¥–Ω–æ —Ñ–æ—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
      const photoGroups = {};
      
      cards.forEach(card => {
        const photoId = card.photoId || card.code;
        if (!photoGroups[photoId]) {
          photoGroups[photoId] = [];
        }
        photoGroups[photoId].push(card);
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ
      const uniquePhotoIds = Object.keys(photoGroups);
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º ${uniquePhotoIds.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –¥–ª—è ${cards.length} –∫–∞—Ä—Ç–æ—á–µ–∫`);
      
      uniquePhotoIds.forEach((photoId, index) => {
        setTimeout(() => {
          const representativeCard = photoGroups[photoId][0];
          loadSingleCardPhoto(representativeCard);
        }, index * 50);
      });
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ
    function loadSingleCardPhoto(card) {
      const photoId = card.photoId || card.code;
      
      // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –≤ –∫—ç—à–µ (–∏–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ –µ–≥–æ –Ω–µ—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –∑–Ω–∞–Ω–∏–µ
      if (photoId in editorImageCache) {
        updateCardPhotoDisplay(card.code, editorImageCache[photoId], card.hasChildren);
        return;
      }
      
      // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
      if (loadingPhotos.has(photoId)) {
        // –ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –≤ –∫—ç—à–µ —É–∂–µ –µ—Å—Ç—å
        setTimeout(() => {
          if (photoId in editorImageCache) {
            updateCardPhotoDisplay(card.code, editorImageCache[photoId], card.hasChildren);
          }
        }, 100);
        return;
      }
      
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –¥–ª—è ${card.code} (photoId: ${photoId})`);
      loadingPhotos.add(photoId);
      
      google.script.run
        .withSuccessHandler(function(imageData) {
          loadingPhotos.delete(photoId);
          
          // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç: imageData (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ null (–µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç)
          editorImageCache[photoId] = imageData;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —ç—Ç–∏–º photoId
          currentCards.forEach(c => {
            if ((c.photoId || c.code) === photoId) {
              updateCardPhotoDisplay(c.code, imageData, c.hasChildren);
            }
          });
        })
        .withFailureHandler(function(error) {
          loadingPhotos.delete(photoId);
          console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ${photoId}:`, error);
          // –ö—ç—à–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          editorImageCache[photoId] = null;
          updateCardPhotoDisplay(card.code, null, card.hasChildren);
        })
        .getProductPhotoBase64(photoId);
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ
    function updateCardPhotoDisplay(cardCode, imageData, hasChildren) {
      const photoContainer = document.getElementById(`photo-${cardCode}`);
      if (!photoContainer) return;
      
      const card = currentCards.find(c => c.code === cardCode);
      if (!card) return; // –í—ã—Ö–æ–¥–∏–º –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
      
      const cardType = card.type;

      let overlayContent = '';
      if (cardType === 'node' && hasChildren) {
        const cachedNode = nodeInfoCache[card.code];
        const operationText = (cachedNode && cachedNode.operation !== undefined) ? (cachedNode.operation || '') : '–∑–∞–≥—Ä—É–∑–∫–∞...';
        if (operationText) {
          overlayContent = `<div class="card-operation-tag" id="operation-tag-${cardCode}">${operationText}</div>`;
        }
      }
      
      // –û—á–∏—â–∞–µ–º –∫–ª–∞—Å—Å—ã
      photoContainer.classList.remove('no-photo');
      
      if (imageData) {
        photoContainer.innerHTML = `
          <img class="photo-loaded visible" src="${imageData}" alt="${cardCode}">
          ${overlayContent}
          <div class="photo-icons">
            ${cardType === 'node' ? `<button class="icon-btn photo" onclick="event.stopPropagation(); editPhotoId('${cardCode}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>` : ''}
            <button class="icon-btn delete" onclick="event.stopPropagation(); deleteCard('${cardCode}', '${cardType}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>
        `;
      } else {
        photoContainer.innerHTML = `
          <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
          ${overlayContent}
          <div class="photo-icons">
            ${cardType === 'node' ? `<button class="icon-btn photo" onclick="event.stopPropagation(); editPhotoId('${cardCode}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>` : ''}
            <button class="icon-btn delete" onclick="event.stopPropagation(); deleteCard('${cardCode}', '${cardType}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>
        `;
        photoContainer.classList.add('no-photo');
      }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞
    function editCurrentNodeName() {
      const nameElement = document.getElementById('currentNodeName');
      const currentName = nameElement.textContent;
      
      const input = document.createElement('input');
      input.className = 'editable-input';
      input.style.fontSize = '18px';
      input.value = currentName;
      input.maxLength = 100;
      
      nameElement.parentNode.replaceChild(input, nameElement);
      input.focus();
      input.select();
      
      const saveEdit = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Å—Ö–µ–º–µ
          if (currentSchema) {
            currentSchema.forEach(item => {
              if (item.target === currentFilterValue) {
                item.targetName = newName;
              }
            });
          }
          
                     // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∫–∞—Ä—Ç–æ—á–µ–∫
           const cacheKey = `${currentViewType}_${currentFilterValue}`;
           if (screenCache[cacheKey]) {
             delete screenCache[cacheKey]; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å
           }
           
           // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫—ç—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª
           if (currentFilterValue === getRootProductCode()) {
             const productsCacheKey = 'products_root';
             if (screenCache[productsCacheKey]) {
               const productCard = screenCache[productsCacheKey].cards.find(card => card.code === currentFilterValue);
               if (productCard) {
                 productCard.name = newName;
               }
             }
           }
           
           // –û–±–Ω–æ–≤–ª—è–µ–º –≤ currentLevel –µ—Å–ª–∏ –µ—Å—Ç—å
           currentLevel.forEach(level => {
             if (level.code === currentFilterValue && level.card) {
               level.card.name = newName;
               level.name = newName;
             }
           });
           
           autoSaveSchema();
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
        const newNameElement = document.createElement('div');
        newNameElement.className = 'current-node-name editable';
        newNameElement.id = 'currentNodeName';
        newNameElement.ondblclick = editCurrentNodeName;
        newNameElement.textContent = newName || currentName;
        input.parentNode.replaceChild(newNameElement, input);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
        updateCurrentNodeBreadcrumb();
      };
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          // –û—Ç–º–µ–Ω–∞
          const originalElement = document.createElement('div');
          originalElement.className = 'current-node-name editable';
          originalElement.id = 'currentNodeName';
          originalElement.ondblclick = editCurrentNodeName;
          originalElement.textContent = currentName;
          input.parentNode.replaceChild(originalElement, input);
        }
      });
      
      input.addEventListener('blur', saveEdit);
    }

    function restoreOperationElement(loaderOrInput, operationText) {
        const operationDiv = document.createElement('div');
        operationDiv.className = 'current-node-operation editable';
        operationDiv.id = 'currentNodeOperation';
        operationDiv.ondblclick = editCurrentNodeOperation;
        operationDiv.textContent = operationText || '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞';
        loaderOrInput.parentNode.replaceChild(operationDiv, loaderOrInput);
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞
    function editCurrentNodeOperation() {
      const operationElement = document.getElementById('currentNodeOperation');
      const currentOperation = operationElement.textContent === '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞' ? '' : operationElement.textContent;

      const input = document.createElement('input');
      input.className = 'editable-input';
      input.style.fontSize = '16px';
      input.value = currentOperation;
      input.maxLength = 150;

      operationElement.parentNode.replaceChild(input, operationElement);
      input.focus();
      input.select();

      const saveEdit = () => {
        const newOperation = input.value.trim();

        if (newOperation !== currentOperation) {
          const loaderElement = document.createElement('div');
          loaderElement.className = 'current-node-operation';
          loaderElement.id = 'currentNodeOperation';
          loaderElement.innerHTML = `<div class="small-loader"></div> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...`;
          input.parentNode.replaceChild(loaderElement, input);

          const productCode = getRootProductCode();
          
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É
                if (currentSchema) {
                  currentSchema.forEach(item => {
                    if (item.target === currentFilterValue) {
                      item.operation = newOperation;
                    }
                  });
                }
                restoreOperationElement(loaderElement, newOperation);
              } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏: ' + result.error);
                restoreOperationElement(loaderElement, currentOperation);
              }
            })
            .withFailureHandler(function(error) {
              alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
              restoreOperationElement(loaderElement, currentOperation);
            })
            .updateOperationForNode(productCode, currentFilterValue, newOperation);
        } else {
          // –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
          restoreOperationElement(input, currentOperation);
        }
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          restoreOperationElement(input, currentOperation);
        }
      });

      input.addEventListener('blur', saveEdit);
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
    function filterCards() {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞
      let searchText = '';
      if (currentViewType === 'products') {
        const searchInput = document.getElementById('searchInput');
        searchText = searchInput ? searchInput.value.toLowerCase() : '';
      } else {
        const nodesSearchInput = document.getElementById('nodesSearchInput');
        searchText = nodesSearchInput ? nodesSearchInput.value.toLowerCase() : '';
      }
      
      const filteredCards = currentCards.filter(card => 
        normalizeCode(card.code).toLowerCase().includes(searchText) || 
        (card.name && card.name.toLowerCase().includes(searchText))
      );
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      const container = currentViewType === 'products' 
        ? document.getElementById('productsGrid')
        : document.getElementById('cardsContent');
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
      renderCards(container, filteredCards);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      setTimeout(() => {
        loadCardsPhotosProgressively(filteredCards);
      }, 50);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
      updateSearchPlaceholder();
    }
    
    // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    function filterProducts() {
      filterCards();
    }

    function createNewProduct() {
      document.getElementById('productModalTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è';
      document.getElementById('productCode').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productModal').classList.add('active');
    }





    function saveProduct() {
      const code = normalizeCode(document.getElementById('productCode').value);
      const name = document.getElementById('productName').value.trim();
      
      if (!code) {
        alert('–ê—Ä—Ç–∏–∫—É–ª –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
      }
      
      // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–¥–µ–ª–∏–µ
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeProductModal();
            invalidateCache('products', null); // –û—á–∏—â–∞–µ–º –∫—ç—à
            loadProducts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
          } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + result.error);
          }
        })
        .createProduct(code, name, null);
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
    }

    // === –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –•–õ–ï–ë–ù–´–ï –ö–†–û–®–ö–ò ===

    let currentLevel = []; // –ü—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É —É—Ä–æ–≤–Ω—é

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∏
    function updateCurrentNodeInfoFromCard(card, isSchemaLoading = false) {
      // –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∏–∑ –∫—ç—à–∞ nodeInfoCache –∏ editorImageCache
      const info = nodeInfoCache[card.code] || card;
      document.getElementById('currentNodeCode').textContent = info.code;
      const nameElement = document.getElementById('currentNodeName');
      nameElement.textContent = info.name;
      const photoContainer = document.getElementById('currentNodePhoto');
      photoContainer.classList.remove('no-photo');
      const photoId = info.photoId || info.code;

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
      const operationElement = document.getElementById('currentNodeOperation');
      const cachedNode = nodeInfoCache[card.code];

      // –ï—Å–ª–∏ –º—ã –∑–Ω–∞–µ–º, —á—Ç–æ —Å—Ö–µ–º–∞ –≥—Ä—É–∑–∏—Ç—Å—è, –∏–ª–∏ –≤ –∫–µ—à–µ –µ—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
      if (isSchemaLoading) {
        operationElement.innerHTML = '<div class="small-loader"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
        operationElement.classList.remove('editable');
        operationElement.ondblclick = null;
      } 
      // –ò–Ω–∞—á–µ, –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –∫–µ—à–∞. findOperationForNode –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ñ–æ–ª–±—ç–∫.
      else {
        const operation = (cachedNode && cachedNode.operation !== undefined) 
                            ? cachedNode.operation 
                            : findOperationForNode(card.code);

        operationElement.textContent = operation || '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞';
        operationElement.classList.add('editable');
        operationElement.ondblclick = editCurrentNodeOperation;
      }

      if (editorImageCache[photoId]) {
        photoContainer.innerHTML = `<img src="${editorImageCache[photoId]}" alt="${info.code}">`;
      } else {
        photoContainer.innerHTML = '<span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>';
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –∫—ç—à–µ
        loadSingleCardPhoto({ code: info.code, photoId: photoId, hasChildren: false });
      }
      updateCurrentNodeBreadcrumb();
    }

    function updateCurrentNodeInfo() {
      if (currentViewType !== 'nodes' || !currentFilterValue) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —É–∑–ª–∞
      document.getElementById('currentNodeCode').textContent = currentFilterValue;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
      let nodeName = getCurrentLevelName(currentFilterValue);
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ –∫—ç—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      if (currentFilterValue === getRootProductCode()) {
        const productsCacheKey = 'products_root';
        if (screenCache[productsCacheKey]) {
          const productCard = screenCache[productsCacheKey].cards.find(card => card.code === currentFilterValue);
          if (productCard) {
            nodeName = productCard.name;
            // –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫—ç—à–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
            const productPhotoId = productCard.photoId || productCard.code;
            if (editorImageCache[productPhotoId] && !editorImageCache[currentFilterValue]) {
              editorImageCache[currentFilterValue] = editorImageCache[productPhotoId];
            }
          }
        }
      }
      
      const nameElement = document.getElementById('currentNodeName');
      nameElement.textContent = nodeName;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
      const operation = findOperationForNode(currentFilterValue);
      const operationElement = document.getElementById('currentNodeOperation');
      if (operationElement) {
        operationElement.textContent = operation || '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–¥–∞–Ω–∞';
        operationElement.classList.add('editable');
        operationElement.ondblclick = editCurrentNodeOperation;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —É–∑–ª–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–Ω–∞—á–∞–ª–∞
      const photoContainer = document.getElementById('currentNodePhoto');
      photoContainer.classList.remove('no-photo');
      
      if (editorImageCache[currentFilterValue]) {
        // –§–æ—Ç–æ —É–∂–µ –≤ –∫—ç—à–µ
        photoContainer.innerHTML = `<img src="${editorImageCache[currentFilterValue]}" alt="${currentFilterValue}">`;
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–æ—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç
        photoContainer.innerHTML = '<div class="photo-loader"></div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        loadSingleImageForCurrentNode(currentFilterValue);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ –≤ –±–ª–æ–∫–µ —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞
      updateCurrentNodeBreadcrumb();
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageLoadQueue = [];
    let isLoadingImages = false;
    const MAX_CONCURRENT_LOADS = 3;
    const IMAGE_LOAD_TIMEOUT = 10000;

    function queueImageLoad(imageCode, callback) {
      imageLoadQueue.push({ code: imageCode, callback: callback });
      processImageQueue();
    }

    function processImageQueue() {
      if (isLoadingImages || imageLoadQueue.length === 0) return;
      
      isLoadingImages = true;
      const batch = imageLoadQueue.splice(0, MAX_CONCURRENT_LOADS);
      
      let completedLoads = 0;
      
      batch.forEach(item => {
        const loadTimeout = setTimeout(() => {
          completedLoads++;
          if (item.callback) item.callback(null);
          
          if (completedLoads === batch.length) {
            isLoadingImages = false;
            processImageQueue();
          }
        }, IMAGE_LOAD_TIMEOUT);
        
        google.script.run
          .withSuccessHandler(function(imageData) {
            clearTimeout(loadTimeout);
            completedLoads++;
            
            if (imageData) {
              editorImageCache[item.code] = imageData;
            }
            
            if (item.callback) item.callback(imageData);
            
            if (completedLoads === batch.length) {
              isLoadingImages = false;
              processImageQueue();
            }
          })
          .withFailureHandler(function(error) {
            clearTimeout(loadTimeout);
            completedLoads++;
            
            if (item.callback) item.callback(null);
            
            if (completedLoads === batch.length) {
              isLoadingImages = false;
              processImageQueue();
            }
          })
          .getProductPhotoBase64(item.code);
      });
    }

    function loadSingleImageForCurrentNode(imageCode) {
      if (!imageCode) return;
      
      const photoContainer = document.getElementById('currentNodePhoto');
      if (!photoContainer) return;
      
      photoContainer.innerHTML = '<div class="photo-loader"></div>';
      
      queueImageLoad(imageCode, function(imageData) {
        if (!photoContainer) return;
        
        if (imageData) {
          photoContainer.innerHTML = `<img src="${imageData}" alt="${imageCode}">`;
          photoContainer.classList.remove('no-photo');
        } else {
          photoContainer.innerHTML = '<span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>';
          photoContainer.classList.add('no-photo');
        }
      });
    }
    
    function updateCurrentNodeBreadcrumb() {
      const breadcrumbContainer = document.getElementById('currentNodeBreadcrumb');
      if (!breadcrumbContainer) return;
      
      const rootCode = getRootProductCode();
      
      let breadcrumbHtml = `<a href="#" class="breadcrumb-link" onclick="goToProductsScreen()">–ò–∑–¥–µ–ª–∏—è</a>`;
      breadcrumbHtml += ` / <a href="#" class="breadcrumb-link" onclick="navigateToLevel('${rootCode}')">${rootCode}</a>`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —É—Ä–æ–≤–Ω–∏
      currentLevel.forEach(level => {
        breadcrumbHtml += ` / <a href="#" class="breadcrumb-link" onclick="navigateToLevel('${level.code}')">${level.code}</a>`;
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–±–µ–∑ —Å—Å—ã–ª–∫–∏)
      if (currentFilterValue !== rootCode && currentFilterValue !== null) {
        breadcrumbHtml += ` / <span style="color: #333; font-weight: bold;">${currentFilterValue}</span>`;
      }
      
      breadcrumbContainer.innerHTML = breadcrumbHtml;
    }

    function getCurrentLevelName(code) {
      // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥—É–∫—Ç, –∏—â–µ–º –≤ currentCards
      if (currentViewType === 'products') {
        const card = currentCards.find(c => c.code === code);
        return card ? card.name : code;
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ —É–∑–µ–ª, –∏—â–µ–º –≤ —Å—Ö–µ–º–µ –∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
      const schemaItem = currentSchema ? currentSchema.find(item => item.target === code || item.source === code) : null;
      if (schemaItem) {
        return schemaItem.targetName || schemaItem.sourceName || code;
      }
      
      const card = currentCards.find(c => c.code === code);
      return card ? card.name : code;
    }
    
    function getRootProductCode() {
      const titleText = document.getElementById('editorTitle').textContent;
      return titleText.split(' - ')[0];
    }
    
    function findOperationForNode(nodeCode) {
      if (!currentSchema || currentSchema.length === 0) return null;
      const schemaRow = currentSchema.find(item => item.target === nodeCode);
      return schemaRow ? schemaRow.operation : null;
    }

    
    function navigateToLevel(levelCode) {
      // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–Ω–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å
      if (levelCode === getRootProductCode()) {
        currentLevel = [];
        currentFilterValue = levelCode;
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –∫—ç—à–µ
        const productsCacheKey = 'products_root';
        if (screenCache[productsCacheKey]) {
          const productCard = screenCache[productsCacheKey].cards.find(card => card.code === levelCode);
          if (productCard) {
            updateCurrentNodeInfoFromCard(productCard);
          }
        }
      } else {
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –≤ –ø—É—Ç–∏ –∏ –æ–±—Ä–µ–∑–∞–µ–º –ø—É—Ç—å –¥–æ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
        const levelIndex = currentLevel.findIndex(item => item.code === levelCode);
        if (levelIndex !== -1) {
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
          const levelData = currentLevel[levelIndex];
          if (levelData.card) {
            updateCurrentNodeInfoFromCard(levelData.card, false);
          }
          
          currentLevel = currentLevel.slice(0, levelIndex);
          currentFilterValue = levelCode;
        }
      }
      
      initializeScreen('nodes', currentFilterValue);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—É–¥–∞–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é)

    // –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

    function clearSelection() {
      document.querySelectorAll('.node-item, .product-card').forEach(item => {
        item.classList.remove('selected');
      });
      selectedNode = null;
    }

    // === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –£–ó–õ–û–í ===

    function addRootNode() {
      selectedNode = { type: 'new', parent: currentLevelCode };
      openNodeModal('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
    }

    function addChildNode(parentCode) {
      selectedNode = { type: 'new', parent: parentCode };
      openNodeModal('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
    }

    function editNode(nodeCode) {
      const schemaItem = currentSchema.find(item => item.target === nodeCode);
      selectedNode = { type: 'edit', code: nodeCode };
      openNodeModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∑–ª–∞', schemaItem);
    }

    function editChildNode(parentCode, childCode) {
      const schemaItem = currentSchema.find(item => item.target === parentCode && item.source === childCode);
      selectedNode = { type: 'edit', code: childCode, parent: parentCode };
      openNodeModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞', schemaItem);
    }

    function openNodeModal(title, data = null) {
      document.getElementById('nodeModalTitle').textContent = title;
      
      if (data) {
        document.getElementById('nodeType').value = data.sourceQuantity === '–æ–ø–µ—Ä–∞—Ü–∏—è' ? 'operation' : 'component';
        document.getElementById('nodeCode').value = data.source || data.target || '';
        document.getElementById('sourceQuantity').value = data.sourceQuantity === '–æ–ø–µ—Ä–∞—Ü–∏—è' ? 1 : data.sourceQuantity || 1;
        document.getElementById('targetQuantity').value = data.targetQuantity || 1;
        document.getElementById('nodeName').value = data.sourceName || data.targetName || '';
        document.getElementById('nodePhotoId').value = data.sourcePhotoId || data.targetPhotoId || '';
      } else {
        document.getElementById('nodeType').value = 'component';
        document.getElementById('nodeCode').value = '';
        document.getElementById('sourceQuantity').value = 1;
        document.getElementById('targetQuantity').value = 1;
        document.getElementById('nodeName').value = '';
        document.getElementById('nodePhotoId').value = '';
      }
      
      onNodeTypeChange();
      document.getElementById('nodeModal').classList.add('active');
    }

    function onNodeTypeChange() {
      const type = document.getElementById('nodeType').value;
      const isOperation = type === 'operation';
      
      document.getElementById('sourceQuantityGroup').style.display = isOperation ? 'none' : 'block';
      document.getElementById('targetQuantityGroup').style.display = isOperation ? 'none' : 'block';
      
      if (isOperation) {
        document.getElementById('sourceQuantity').value = '–æ–ø–µ—Ä–∞—Ü–∏—è';
      }
    }

    function saveNode() {
      const type = document.getElementById('nodeType').value;
      const code = normalizeCode(document.getElementById('nodeCode').value.trim());
      const sourceQuantity = type === 'operation' ? '–æ–ø–µ—Ä–∞—Ü–∏—è' : document.getElementById('sourceQuantity').value;
      const targetQuantity = document.getElementById('targetQuantity').value;
      const name = document.getElementById('nodeName').value.trim();
      const photoId = normalizeCode(document.getElementById('nodePhotoId').value.trim());
      
      if (!code) {
        alert('–ê—Ä—Ç–∏–∫—É–ª/–Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const titleText = document.getElementById('editorTitle').textContent;
      const productCode = titleText.split(': ')[1].split(' - ')[0];
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
      const targetItem = currentSchema.find(item => item.target === selectedNode.parent || item.source === selectedNode.parent);
      const targetName = targetItem ? (targetItem.targetName || targetItem.sourceName || selectedNode.parent) : selectedNode.parent;
      
      const nodeData = {
        source: code,
        target: selectedNode.parent,
        sourceQuantity: sourceQuantity,
        targetQuantity: targetQuantity,
        sourceName: name,
        sourcePhotoId: photoId,
        productCode: productCode,
        targetName: targetName // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
      };
      
      if (selectedNode.type === 'new') {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å—Ö–µ–º—É
        currentSchema.push(nodeData);
      } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        const index = currentSchema.findIndex(item => 
          (selectedNode.parent ? 
            item.target === selectedNode.parent && item.source === selectedNode.code :
            item.target === selectedNode.code
          )
        );
        if (index !== -1) {
          currentSchema[index] = { ...currentSchema[index], ...nodeData };
        }
      }
      
      closeNodeModal();
      renderTree();
      clearSelection();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã
    function autoSaveSchema() {
      if (!currentSchema || currentSchema.length === 0) return;
      
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const titleText = document.getElementById('editorTitle').textContent;
      const productCode = titleText.split(' - ')[0];
      
      if (!productCode) return;
      
      console.log('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã...');
      
      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
      invalidateCache('nodes', currentFilterValue);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result.error);
          }
        })
        .withFailureHandler(function(error) {
          console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error.message);
        })
        .saveProductSchema(productCode, currentSchema);
    }

    function closeNodeModal() {
      document.getElementById('nodeModal').classList.remove('active');
    }

    function deleteNode(nodeCode) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –∏ –≤—Å–µ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã?')) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
        currentSchema = currentSchema.filter(item => 
          item.target !== nodeCode && item.source !== nodeCode
        );
        renderTree();
      }
    }

    function deleteChildNode(parentCode, childCode) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
        currentSchema = currentSchema.filter(item => 
          !(item.target === parentCode && item.source === childCode)
        );
        renderTree();
      }
    }

    // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–í–û–ô–°–¢–í –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò ===

    function updateNodeType(nodeCode) {
      const newType = document.getElementById('nodeTypeEdit').value;
      const isOperation = newType === 'operation';
      
      const item = currentSchema.find(item => item.source === nodeCode && item.target === currentLevelCode);
      if (item) {
        item.sourceQuantity = isOperation ? '–æ–ø–µ—Ä–∞—Ü–∏—è' : 1;
      }
      
      document.getElementById('quantityGroupEdit').style.display = isOperation ? 'none' : 'block';
      renderTree();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    function updateNodeCode(oldNodeCode) {
      const newCode = document.getElementById('nodeCodeEdit').value;
      const item = currentSchema.find(item => item.source === oldNodeCode && item.target === currentLevelCode);
      if (item) {
        item.source = newCode;
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≥–¥–µ —ç—Ç–æ—Ç –∫–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–µ–≤—ã–º
        currentSchema.forEach(schemaItem => {
          if (schemaItem.target === oldNodeCode) {
            schemaItem.target = newCode;
          }
        });
      }
      renderTree();
      clearSelection();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    function updateNodeQuantity(nodeCode) {
      const newQuantity = document.getElementById('nodeQuantityEdit').value;
      const item = currentSchema.find(item => item.source === nodeCode && item.target === currentLevelCode);
      if (item) {
        item.sourceQuantity = newQuantity;
      }
      renderTree();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    function updateNodeName(nodeCode) {
      const newName = document.getElementById('nodeNameEdit').value;
      const item = currentSchema.find(item => item.source === nodeCode && item.target === currentLevelCode);
      if (item) {
        item.sourceName = newName;
      }
      renderTree();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    function updateNodePhoto(nodeCode) {
      const newPhotoId = document.getElementById('nodePhotoEdit').value;
      const item = currentSchema.find(item => item.source === nodeCode && item.target === currentLevelCode);
      if (item) {
        item.sourcePhotoId = newPhotoId;
      }
      loadSingleImage(newPhotoId);
      renderTree();
      autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }
    
    function deleteCurrentNode(nodeCode) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç –∏ –≤—Å–µ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã?')) {
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏ –≤—Å–µ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
        deleteNodeRecursive(nodeCode);
        renderTree();
        clearSelection();
        autoSaveSchema(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      }
    }
    
    function deleteNodeRecursive(nodeCode) {
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const childrenToDelete = currentSchema.filter(item => item.target === nodeCode);
      childrenToDelete.forEach(child => {
        deleteNodeRecursive(child.source);
      });
      
      // –£–¥–∞–ª—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
      currentSchema = currentSchema.filter(item => 
        !(item.source === nodeCode || item.target === nodeCode)
      );
    }

    function updateNodeNameOld(nodeCode) {
      const newName = document.getElementById('nodeNameEdit').value;
      currentSchema.forEach(item => {
        if (item.target === nodeCode) {
          item.targetName = newName;
        }
      });
      renderTree();
    }

    function updateNodePhoto(nodeCode) {
      const newPhotoId = document.getElementById('nodePhotoEdit').value;
      currentSchema.forEach(item => {
        if (item.target === nodeCode) {
          item.targetPhotoId = newPhotoId;
        }
      });
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
      loadSingleImage(newPhotoId);
      renderTree();
    }

    function updateChildType(parentCode, childCode) {
      const newType = document.getElementById('childTypeEdit').value;
      const isOperation = newType === 'operation';
      
      const item = currentSchema.find(item => item.target === parentCode && item.source === childCode);
      if (item) {
        item.sourceQuantity = isOperation ? '–æ–ø–µ—Ä–∞—Ü–∏—è' : 1;
      }
      
      document.getElementById('quantityGroup').style.display = isOperation ? 'none' : 'block';
      renderTree();
    }

    function updateChildCode(parentCode, oldChildCode) {
      const newCode = document.getElementById('childCodeEdit').value;
      const item = currentSchema.find(item => item.target === parentCode && item.source === oldChildCode);
      if (item) {
        item.source = newCode;
      }
      renderTree();
    }

    function updateChildQuantity(parentCode, childCode) {
      const newQuantity = document.getElementById('childQuantityEdit').value;
      const item = currentSchema.find(item => item.target === parentCode && item.source === childCode);
      if (item) {
        item.sourceQuantity = newQuantity;
      }
      renderTree();
    }

    function updateChildName(parentCode, childCode) {
      const newName = document.getElementById('childNameEdit').value;
      const item = currentSchema.find(item => item.target === parentCode && item.source === childCode);
      if (item) {
        item.sourceName = newName;
      }
      renderTree();
    }

    function updateChildPhoto(parentCode, childCode) {
      const newPhotoId = document.getElementById('childPhotoEdit').value;
      const item = currentSchema.find(item => item.target === parentCode && item.source === childCode);
      if (item) {
        item.sourcePhotoId = newPhotoId;
      }
      loadSingleImage(newPhotoId);
      renderTree();
    }

    // === –†–ê–ë–û–¢–ê –° –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø–ú–ò ===

    function getImageFromCache(imageCode) {
      return editorImageCache[imageCode] || null;
    }

    function loadSingleImage(imageCode) {
      if (imageCode && !editorImageCache[imageCode]) {
        google.script.run
          .withSuccessHandler(function(imageData) {
            if (imageData) {
              editorImageCache[imageCode] = imageData;
            }
          })
          .getProductPhotoBase64(imageCode);
      }
    }

    // === –°–û–•–†–ê–ù–ï–ù–ò–ï –°–•–ï–ú–´ ===
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ autoSaveSchema()

    function updateOperationTags() {
      console.log("Updating operation tags from cache...");
      currentCards.forEach(card => {
        if (card.type === 'node' && card.hasChildren) {
          const tagElement = document.getElementById('operation-tag-' + card.code);
          if (tagElement) {
            const cachedNode = nodeInfoCache[card.code];
            const operationText = (cachedNode && cachedNode.operation !== undefined) ? (cachedNode.operation || null) : 'loading';

            if (operationText === 'loading') {
              tagElement.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
              tagElement.style.display = 'block';
            } else if (operationText) {
              tagElement.textContent = operationText;
              tagElement.style.display = 'block';
            } else {
              // –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–≥
              tagElement.style.display = 'none';
            }
          }
        }
      });
    }
  </script>
</body>
</html> 